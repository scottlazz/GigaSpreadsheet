let t;var e=globalThis,i={},s={},l=e.parcelRequire8661;null==l&&((l=function(t){if(t in i)return i[t].exports;if(t in s){var e=s[t];delete s[t];var l={id:t,exports:{}};return i[t]=l,e.call(l.exports,l,l.exports),l.exports}var o=Error("Cannot find module '"+t+"'");throw o.code="MODULE_NOT_FOUND",o}).register=function(t,e){s[t]=e},e.parcelRequire8661=l),(0,l.register)("5Mp1b",function(t,e){t.exports=JSON.parse('{"options":{"syntax":"proto3"},"nested":{"yaticker":{"fields":{"id":{"type":"string","id":1},"price":{"type":"float","id":2},"time":{"type":"sint64","id":3},"currency":{"type":"string","id":4},"exchange":{"type":"string","id":5},"quoteType":{"type":"QuoteType","id":6},"marketHours":{"type":"MarketHoursType","id":7},"changePercent":{"type":"float","id":8},"dayVolume":{"type":"sint64","id":9},"dayHigh":{"type":"float","id":10},"dayLow":{"type":"float","id":11},"change":{"type":"float","id":12},"shortName":{"type":"string","id":13},"expireDate":{"type":"sint64","id":14},"openPrice":{"type":"float","id":15},"previousClose":{"type":"float","id":16},"strikePrice":{"type":"float","id":17},"underlyingSymbol":{"type":"string","id":18},"openInterest":{"type":"sint64","id":19},"optionsType":{"type":"OptionType","id":20},"miniOption":{"type":"sint64","id":21},"lastSize":{"type":"sint64","id":22},"bid":{"type":"float","id":23},"bidSize":{"type":"sint64","id":24},"ask":{"type":"float","id":25},"askSize":{"type":"sint64","id":26},"priceHint":{"type":"sint64","id":27},"vol_24hr":{"type":"sint64","id":28},"volAllCurrencies":{"type":"sint64","id":29},"fromcurrency":{"type":"string","id":30},"lastMarket":{"type":"string","id":31},"circulatingSupply":{"type":"double","id":32},"marketcap":{"type":"double","id":33}},"nested":{"QuoteType":{"values":{"NONE":0,"ALTSYMBOL":5,"HEARTBEAT":7,"EQUITY":8,"INDEX":9,"MUTUALFUND":11,"MONEYMARKET":12,"OPTION":13,"CURRENCY":14,"WARRANT":15,"BOND":17,"FUTURE":18,"ETF":20,"COMMODITY":23,"ECNQUOTE":28,"CRYPTOCURRENCY":41,"INDICATOR":42,"INDUSTRY":1000}},"OptionType":{"values":{"CALL":0,"PUT":1}},"MarketHoursType":{"values":{"PRE_MARKET":0,"REGULAR_MARKET":1,"POST_MARKET":2,"EXTENDED_HOURS_MARKET":3}}}}}}')});class o{constructor(){this.container=document.createElement("div"),this.container.className="gigasheet-bottombar",this.container.innerHTML=`
            <div class="gigasheet-contextmenu" style="width: 160px; display: none; left: 271px; bottom: 41px;">
                <div class="gigasheet-item">Delete</div>
            </div>
            <ul class="gigasheet-menu">
                <li class="">
                    <div class="gigasheet-icon">
                        <div class="gigasheet-icon-img add"></div>
                    </div><span class="">
                        <div class="gigasheet-dropdown top-left">
                            <div class="gigasheet-dropdown-header">
                                <div class="gigasheet-icon">
                                    <div class="gigasheet-icon-img ellipsis"></div>
                                </div>
                            </div>
                            <div class="gigasheet-dropdown-content" style="width: auto; display: none;">
                                <div class="gigasheet-item" style="width: 150px; font-weight: normal;">Sheet1</div>
                            </div>
                        </div>
                    </span>
                </li>
            </ul>
        `,this.menu=this.container.querySelector(".gigasheet-menu"),this.active=1,this.tabCbs=[],this.addListeners()}addListeners(){this.menu.addEventListener("click",t=>{t.target.hasAttribute("data-tabid")&&t.target.getAttribute("data-tabid")!==String(this.active)&&this.setActive(t.target.getAttribute("data-tabid"))})}setActive(t){let e=this.container.querySelector(`[data-tabid='${t}']`);e&&(this.removeActive(),this.active=t,e.classList.add("active"),this.emit(t))}emit(t){this.tabCbs.forEach(e=>{e(t)})}onTabClicked(t){this.tabCbs.push(t)}removeActive(){for(let t of this.container.querySelector(".gigasheet-menu").children)t.classList.remove("active")}addTab(t,e){let i=this.container;this.active=e;let s=i.querySelector(".gigasheet-menu");this.removeActive(),s.lastElementChild?s.lastElementChild.insertAdjacentHTML("afterend",`<li data-tabid="${e}" class="active">Sheet${e}</div>`):s.innerHTML='<li data-tabid="1" class="active gigasheet-bottom-tab">Sheet1</li>'}}const n=(t=1,function(){return t++});class r{constructor(){this._data=[],this._colCounts=[],this._topRow=1/0,this._bottomRow=-1/0,this._leftCol=1/0,this._rightCol=-1/0,this._totalValues=0,this._totalRows=0,this._totalCols=0,this._valueCount=0}save(){return JSON.stringify({d:Object.keys(this._data).map(t=>[Number(t),Object.keys(this._data[t]).map(e=>["count"===e?e:Number(e),this._data[t][e]])]),cc:Object.entries(this._colCounts).map(([t,e])=>[Number(t),e]),tr:this._topRow,br:this._bottomRow,lc:this._leftCol,rc:this._rightCol,tv:this._totalValues,trow:this._totalRows,tcol:this._totalCols})}restore(t){let e=JSON.parse(t);return this.clear(),e.d.forEach(([t,e])=>{this._data[t]=[],e.forEach(([e,i])=>{this._data[t][e]=i})}),e.cc.forEach(([t,e])=>{this._colCounts[t]=e}),this._topRow=e.tr,this._bottomRow=e.br,this._leftCol=e.lc,this._rightCol=e.rc,this._totalValues=e.tv,this._totalRows=e.trow,this._totalCols=e.tcol,this}setCellProperty(t,e,i,s){let l=this.get(t,e);l._id||(l._id=n()),l[i]=s,this.set(t,e,l)}setRowSize(t,e){this._data[t]&&(this._data[t].size=e)}incrementRowSize(t){this._data[t]&&this._data[t].size++}decrementRowSize(t){this._data[t]&&this._data[t].size--}set(t,e,i){if(!Number.isInteger(t)||!Number.isInteger(e))throw Error("Coordinates must be integers");let s=!this._data[t],l=s||!Object.hasOwn(this._data[t],e),o=l&&!this._colCounts[e];return s&&(this._data[t]=[],this.setRowSize(t,0),this._totalRows++,t<this._topRow&&(this._topRow=t),t>this._bottomRow&&(this._bottomRow=t)),l&&(this.incrementRowSize(t),this._totalValues++,o&&(this._colCounts[e]=0,this._totalCols++),this._colCounts[e]++,e<this._leftCol&&(this._leftCol=e),e>this._rightCol&&(this._rightCol=e)),this._data[t][e]=i,i._id||(i._id=n()),l}decrementColSize(t){this._colCounts[t]--,this._colCounts[t]<=0&&delete this._colCounts[t]}incrementColSize(t){this._colCounts[t]||(this._colCounts[t]=0),this._colCounts[t]++}deleteRow(t){let e=this._data[t];if(e){for(let t in e)this.decrementColSize(t);this._totalRows--}return this._data.splice(t,1),this._recalculateBoundaries(),e}addRow(t,e=[]){for(let t in e=e||[])this.incrementColSize(t);return e.length>0&&this._totalRows++,this._data.splice(t,0,e),this._recalculateBoundaries(),null}addCol(t,e=[]){for(let i in e=e||[],this._data)"count"!==i&&(this._data[i].splice(t,0,void 0),delete this._data[i][t],i in e&&(this._data[i][t]=e[i],this.incrementRowSize(i)));return e.length>0&&this._totalCols++,this._recalculateBoundaries(),null}getCol(t){let e=[];for(let i in this._data)"count"!==i&&t in this._data[i]&&(e[i]=this._data[i][t]);return e}deleteCol(t){let e=this.getCol(t);for(let i in e.size=this._colCounts[t],this._colCounts[t]&&this._totalCols--,this._data)"count"!==i&&(this.has(i,t)&&this.decrementColSize(t),this._data[i].splice(t,1));return this._colCounts.splice(t,1),this._recalculateBoundaries(),e}delete(t,e){if(!this.has(t,e))return!1;delete this._data[t][e],this.decrementRowSize(t),this._colCounts[e]--,this._totalValues--,0===this._data[t].size&&(delete this._data[t],this._totalRows--),0===this._colCounts[e]&&(delete this._colCounts[e],this._totalCols--);let i=!1;return(t===this._topRow||t===this._bottomRow)&&(i=!0),(e===this._leftCol||e===this._rightCol)&&(i=!0),i&&this._recalculateBoundaries(),!0}_recalculateBoundaries(){if(0===this.totalRows){this._topRow=1/0,this._bottomRow=-1/0,this._leftCol=1/0,this._rightCol=-1/0;return}let t=1/0,e=-1/0,i=1/0,s=-1/0;for(let l in this._data)for(let o in(l=parseInt(l))<t&&(t=l),l>e&&(e=l),this._data[l])(o=parseInt(o))<i&&(i=o),o>s&&(s=o);this._topRow=t,this._bottomRow=e,this._leftCol=i,this._rightCol=s}get(t,e){return this._data[t]&&Object.hasOwn(this._data[t],e)?this._data[t][e]:{row:t,col:e}}has(t,e=null){return null==e?Object.hasOwn(this._data,t):Object.hasOwn(this._data,t)&&Object.hasOwn(this._data[t],e)}deleteCells(t){let e=0,i=!1,s={};for(let[l,o]of t)Number.isInteger(l)&&Number.isInteger(o)&&this.has(l,o)&&(delete this._data[l][o],this.decrementRowSize(l),this._colCounts[o]--,e++,s[l]=!0,(o===this._leftCol||o===this._rightCol)&&(i=!0));for(let t in s)if(0===this._data[t].size){delete this._data[t];let e=Number(t);(e===this._topRow||e===this._bottomRow)&&(i=!0)}return this._totalValues-=e,i&&this._recalculateBoundaries(),e}getRowCount(t){return this._data[t].size||0}getRowCounts(){return Object.fromEntries(Object.entries(this._data).map(([t,e])=>[Number(t),e.size]))}deleteCellsArea(t,e,i,s){let[l,o]=[Math.min(t,i),Math.max(t,i)],[n,r]=[Math.min(e,s),Math.max(e,s)],a=0,h=!1,d=[];for(let t in this._rows)t>=l&&t<=o&&d.push(t);for(let t of d){let e=this._rows[t],i=[];for(let t in e)t>=n&&t<=r&&i.push(t);for(let s of i)delete e[s],this.decrementRowSize(t),this._colCounts[s]--,a++,(s==this._leftCol||s==this._rightCol)&&(h=!0);0===this._data[t].size&&(delete this._data[t],this._totalRows--,h=!0)}return this._valueCount-=a,h&&this._recalculateBoundaries(),a}getCells(t,e,i,s){let l=[],[o,n]=[Math.min(t,i),Math.max(t,i)],[r,a]=[Math.min(e,s),Math.max(e,s)];for(let t of Object.keys(this._data).map(Number).filter(t=>t>=o&&t<=n))for(let e of Object.keys(this._data[t]).map(Number).filter(t=>t>=r&&t<=a))l.push({row:t,col:e,value:this._data[t][e]});return l}getCellsForce(t,e,i,s){let l=[];for(let o=t;o<=i;o++)for(let t=e;t<=s;t++)l.push({row:o,col:t});return l}get topRow(){return this._topRow===1/0?null:this._topRow}get bottomRow(){return this._bottomRow===-1/0?null:this._bottomRow}get leftCol(){return this._leftCol===1/0?null:this._leftCol}get rightCol(){return this._rightCol===-1/0?null:this._rightCol}get totalRows(){return this._totalRows}get totalColumns(){return this._totalCols}get totalValues(){return this._totalValues}get rowCount(){return this._topRow!==1/0&&this._bottomRow!==-1/0?this._bottomRow-this._topRow+1:0}get colCount(){return this._leftCol!==1/0&&this._rightCol!==-1/0?this._rightCol-this._leftCol+1:0}get valueCount(){return this._valueCount}get allDimensions(){return{topRow:this.topRow,bottomRow:this.bottomRow,leftCol:this.leftCol,rightCol:this.rightCol,rowCount:this.rowCount,colCount:this.colCount,totalValues:this.totalValues}}clear(){this._data=[],this._topRow=1/0,this._bottomRow=-1/0,this._leftCol=1/0,this._rightCol=-1/0,this._valueCount=0}forEach(t){let e=0;for(let i in this._data)if("count"!==i)for(let s in this._data[i])t(this._data[i][s],i,s,e++)}}class a{constructor(){if(a._instance)return a._instance;a._instance=this,this._data={}}store(t,e,i){this._data[t]||(this._data[t]={}),this._data[t][e]=i}get(t,e){return this._data[t]&&Object.hasOwn(this._data[t],e)?this._data[t][e]:null}}const h={},d={},c={};function u(t){for(let e in t)if(Object.hasOwn(t,e))return!1;return!0}class g{constructor(t){this.data=t,this.finData=new a}addDependency(t,e){let i=t[0],s=t[1],l=e[0],o=e[1];h[l]||(h[l]={}),h[l][o]||(h[l][o]={}),h[l][o][i]||(h[l][o][i]={}),h[l][o][i][s]=!0,d[i]||(d[i]={}),d[i][s]||(d[i][s]={}),d[i][s][l]||(d[i][s][l]={}),d[i][s][l][o]=!0}tokenize(t){let e;t.startsWith("=")&&(t=t.slice(1));let i=[],s=/\s*(=>|[-+*/^()]|[A-Za-z_]\w*|\d*\.?\d+|\S)\s*/g;for(;null!==(e=s.exec(t));)i.push(e[1]);return i}static tokenizeWithIndex(t){let e;t.startsWith("=")&&(t=t.slice(1));let i=[],s=/\s*(=>|[-+*/^()]|[A-Za-z_]\w*|\d*\.?\d+|\S)\s*/dg;for(;null!==(e=s.exec(t));)i.push([e[1],e.indices[1]]);return i}parse(t){let e=0,i=()=>{let i=s();for(;e<t.length&&("+"===t[e]||"-"===t[e]);){let l=t[e];e++,i={type:"BinaryExpression",operator:l,left:i,right:s()}}return i},s=()=>{let i=l();for(;e<t.length&&("*"===t[e]||"/"===t[e]);){let s=t[e];e++,i={type:"BinaryExpression",operator:s,left:i,right:l()}}return i},l=()=>{if("("===t[e]){e++;let s=i();if(")"!==t[e])throw Error("Expected closing parenthesis");return e++,s}if(/^\d+$/.test(t[e]))return{type:"Number",value:parseFloat(t[e++])};if(":"===t[e])return{type:"RangeReference",value:t[e++]};if(/^[A-Za-z]+\d+$/.test(t[e]))return":"===t[e+1]?{type:"RangeReference",value:`${t[e++]}${t[e++]}${t[e++]}`}:{type:"CellReference",value:t[e++]};if(/^[A-Za-z_]\w*$/.test(t[e]))return{type:"Function",name:t[e++],args:o()};else throw Error(`Unexpected token: ${t[e]}`)},o=()=>{let s=[];if("("===t[e]){for(e++;")"!==t[e];)s.push(i()),","===t[e]&&e++;e++}return s};return i()}evaluate(t,e){switch(t.type){case"Number":return t.value;case"CellReference":if(e){let{row:i,col:s}=this.parseCellReference(t.value);this.addDependency(e,[i,s])}return this.getCellValue(t.value);case"RangeReference":if(e){let[i,s]=t.value.split(":"),l=this.parseCellReference(i),o=this.parseCellReference(s);for(let t=l.row;t<=o.row;t++)for(let i=l.col;i<=o.col;i++)this.addDependency(e,[t,i])}return this.getRangeValues(t.value);case"BinaryExpression":return this.evaluateBinaryExpression(t,e);case"Function":return this.evaluateFunction(t,e);default:throw Error(`Unknown AST node type: ${t.type}`)}}evaluateBinaryExpression(t,e){let i=this.evaluate(t.left,e),s=this.evaluate(t.right,e);switch(t.operator){case"+":return i+s;case"-":return i-s;case"*":return i*s;case"/":return i/s;case"^":return Math.pow(i,s);default:throw Error(`Unknown operator: ${t.operator}`)}}evaluateFunction(t,e){let i=t.args.map(t=>this.evaluate(t));switch(t.name.toUpperCase()){case"SUM":return i.flat().reduce((t,e)=>t+e,0);case"AVERAGE":let s=i.flat();return s.reduce((t,e)=>t+e,0)/s.length;case"ERROR":return"ERROR";case"REFERROR":return"REFERROR";default:if(console.log("subbing",t.name),c[t.name]||(c[t.name]={}),c[t.name][`${e[0]},${e[1]}`]=!0,this.finData.get("YA",t.name))return this.finData.get("YA",t.name).price;return""}}getCellText(t,e){return this.data.get(t,e)?.text??""}getCellValue(t){let{row:e,col:i}=this.parseCellReference(t);if(e<0||e>this.bottomRow||i<0||i>this.data.rightCol)return"";let s=this.getCellText(e,i);return"string"==typeof s&&s.startsWith("=")?this.evaluateExpression(s,[e,i]):"number"==typeof s?s:parseFloat(s)||0}getRangeValues(t){let[e,i]=t.split(":"),s=this.parseCellReference(e),l=this.parseCellReference(i),o=[];for(let e=s.row;e<=l.row;e++)for(let i=s.col;i<=l.col;i++){if(e<0||e>=this.data.bottomRow||i<0||i>=this.rightCol)throw Error(`Invalid cell in range: ${t}`);let s=this.getCellText(e,i);"string"==typeof s&&s.startsWith("=")?o.push(this.evaluateExpression(s,[e,i])):o.push("number"==typeof s?s:parseFloat(s)||0)}return o}parseCellReference(t){let e=t.match(/[A-Za-z]+/)?.[0],i=t.match(/\d+/)?.[0];if(!e||!i)throw Error(`Invalid cell reference: ${t}`);let s=e.split("").reduce((t,e)=>26*t+(e.toUpperCase().charCodeAt(0)-64),0)-1;return{row:parseInt(i,10)-1,col:s}}static parseCellReference(t){let e=t.match(/[A-Za-z]+/)?.[0],i=t.match(/\d+/)?.[0];if(!e||!i)throw Error(`Invalid cell reference: ${t}`);let s=e.split("").reduce((t,e)=>26*t+(e.toUpperCase().charCodeAt(0)-64),0)-1;return{row:parseInt(i,10)-1,col:s}}getAst(t){if(t.startsWith("=")){let e=this.tokenize(t);return this.parse(e)}return null}evaluateExpression(t,e){if("string"!=typeof t)return t;if(t.startsWith("=")){let i=this.tokenize(t),s=this.parse(i);return this.evaluate(s,e)}return parseFloat(t)||t}}class p{constructor(){this.onmessage=t=>{try{let e=t.data,i=this.Yaticker?.decode(new Uint8Array(atob(e).split("").map(t=>t.charCodeAt(0))));i.id.startsWith("^")&&(i._id=i.id,i.id=i.id.slice(1)),this.data.store("YA",i.id,i),console.log("tick data:",i),this.updateListeners(i)}catch(t){console.log(t)}},this.tickers=new Set,this.connection=null,this.data=new a,this.isOpen=!1,this.root=protobuf.Root.fromJSON(l("5Mp1b")),this.Yaticker=this.root?.lookupType("yaticker"),this.cbs=[]}getSubString(){return JSON.stringify({subscribe:[...this.tickers]})}hasSubs(){return this.tickers.size>0}addListener(t){this.cbs.push(t)}updateSubs(){return this.connection?this.hasSubs()&&this.connection.send(this.getSubString()):(this.connection=new WebSocket(atob("d3NzOi8vc3RyZWFtZXIuZmluYW5jZS55YWhvby5jb20v")),this.connection.onopen=()=>{this.isOpen=!0,this.hasSubs()&&this.connection.send(this.getSubString())},this.connection.onmessage=this.onmessage),this.connection}updateListeners(t){for(let e of this.cbs)e(t)}async fetchTicker(t){}addSubs(t){for(let e of t)this.tickers.has(e)||this.fetchTicker(e),this.tickers.add(e);this.hasSubs()&&this.updateSubs()}}class f{constructor(){if(f._instance)return f._instance;f._instance=this,this.ya=new p,this.tickListeners=[],this.ya.addListener(t=>{for(let e of this.tickListeners)e(t)})}listenYA(t){this.ya.addSubs(t)}onTick(t){this.tickListeners.push(t)}}function w(t,e){let i;if(!t)return!1;if("left"===e)i=2;else if("top"===e)i=4;else if("right"===e)i=8;else{if("bottom"!==e)return 0;i=16}return i===(i&t)}function C(t="div",e="",i){let s=document.createElement(t);return s.className=e,i&&(s.innerHTML=i),s}function b(t,e){let i={up:[-1,0],down:[1,0],left:[0,-1],right:[0,1]}[e];t=t.slice(1);let s=g.tokenizeWithIndex(t);s.reverse();let l="=";for(let e=0;e<t.length;e++){for(;s.length>0&&!/^[A-Za-z]+\d+$/.test(s[s.length-1][0]);)s.pop();let[o,n]=s[s.length-1]||["",[]];if(e===n[0]){let t=g.parseCellReference(o),r=function(t,e){if(t<0||e<0||!Number.isInteger(t)||!Number.isInteger(e))return"";let i="",s=e+1;for(;s>0;)i=String.fromCharCode(65+(s-1)%26)+i,s=Math.floor((s-1)/26);return i+(t+1)}(t.row+i[0],t.col+i[1]);r?l+=r:l+="REFERROR",s.pop(),e=n[1]-1}else l+=t[e]}return l}const m=`
<style>
    .header-bar {
        font-family: Arial, sans-serif;
        background-color: #f3f3f3;
        padding: 5px;
        border-bottom: 1px solid #d4d4d4;
        display: flex;
        flex-wrap: wrap;
        z-index: 300;
    }

    .tab-group {
        display: flex;
        margin-right: 15px;
    }

    .button-group {
        display: flex;
        border-right: 1px solid #d4d4d4;
        padding: 3px 10px 3px 3px;
        align-items: center;
    }

    .button {
        background: none;
        border: none;
        padding: 5px 8px;
        margin: 0 2px;
        cursor: pointer;
        border-radius: 3px;
    }

    .button:hover {
        background-color: #e0e0e0;
    }

    .button img {
        width: 16px;
        height: 16px;
    }

    .separator {
        width: 1px;
        background-color: #d4d4d4;
        margin: 0 5px;
        height: 30px;
    }

    .dropdown {
        position: relative;
        display: inline-block;
    }

    .dropdown-content {
        display: none;
        position: absolute;
        background-color: #f9f9f9;
        min-width: 130px;
        box-shadow: 0px 8px 16px 0px rgba(0, 0, 0, 0.2);
        z-index: 1;
        font-size: 14px;
        border: 1px solid #d4d4d4;
    }
    .dropdown-content > div {
        border-bottom: 1px solid #d4d4d4;
        padding: 2px;
        cursor: pointer;
    }

    .dropdown-content > div:last-child {
        border-bottom: none;
    }

    .dropdown:hover .dropdown-content {
        display: block;
        z-index: 300;
    }
</style>
<div class="header-bar">
    <!-- Clipboard Group -->
    <div class="button-group quick-text-actions-buttons">
        <button class="button" data-action="paste" title="Paste">\u{1F4CB}</button>
        <button class="button" data-action="cut" title="Cut">\u{2702}\u{FE0F}</button>
        <button class="button" data-action="copy" title="Copy">\u{1F4C4}</button>
        <div class="separator"></div>
        <div class="dropdown">
            <button id="format-button" class="button format-button" title="Format Painter">\u{1F58C}\u{FE0F}</button>
        </div>
    </div>

    <!-- Font Group -->
    <div class="button-group">
        <div class="dropdown">
            <button class="button" title="Font">Arial \u{25BC}</button>
            <div class="dropdown-content">
                <div>Arial</div>
                <div>Calibri</div>
                <div>Times New Roman</div>
            </div>
        </div>
        <div class="dropdown">
            <button class="button" title="Font Size">11 \u{25BC}</button>
        </div>
        <button class="button" title="Bold">B</button>
        <button class="button" title="Italic">I</button>
        <button class="button" title="Underline">U</button>
        <div class="separator"></div>
        <button class="button" title="Border">\u{29C9}</button>
        <div class="dropdown">
            <button class="button" title="Fill Color">\u{25A3}</button>
        </div>
        <div class="dropdown">
            <button class="button" title="Font Color">A</button>
        </div>
    </div>

    <!-- Alignment Group -->
    <div class="button-group align-button-group">
        <button class="button" data-align="left" title="Align Left">\u{2261}</button>
        <button class="button" data-align="center" title="Align Center">\u{2261}</button>
        <button class="button" data-align="right" title="Align Right">\u{2261}</button>
        <div class="separator"></div>
        <button class="button merge-button" title="Merge & Center" id="merge-button">\u{29C9} M</button>
    </div>

    <!-- Editing Group -->
    <div class="button-group">
        <div class="dropdown">
            <button class="button" title="Insert">\u{2295} Insert</button>
        </div>
        <div class="dropdown">
            <button class="button" title="Delete">\u{2296} Delete</button>
        </div>
        <div class="separator"></div>
        <div class="dropdown">
            <button class="button" title="Conditional Formatting">\u{2630} Format</button>
        </div>
    </div>
</div>
`,v=[{key:"copy",title:"Copy",label:"Ctrl+C"},{key:"cut",title:"Cut",label:"Ctrl+X"},{key:"paste",title:"Paste",label:"Ctrl+V"},{key:"paste-value",title:"Paste values only",label:"Ctrl+Shift+V"},{key:"paste-format",title:"Paste format only",label:"Ctrl+Alt+V"},{key:"divider"},{key:"insert-row",title:"Insert row"},{key:"insert-column",title:"Insert column"},{key:"divider"},{key:"merge",title:"Merge"},{key:"unmerge",title:"Unmerge"},{key:"divider"},{key:"delete-row",title:"Delete row"},{key:"delete-column",title:"Delete column"},{key:"delete-cell-text",title:"Delete cell text"},{key:"clear",title:"Clear Contents",label:""},{key:"divider"},{key:"toggle-gridlines",title:"Toggle Gridlines"}];class R{constructor(){for(let t of(this.menuItems=v.map(t=>(function(t){if("divider"===t.key)return C("div","gigasheet-item divider");let e=C("div","gigasheet-item",`
        ${t.title}
        <div class="label">${t.label||""}</div>
    `);return e.setAttribute("data-key",t.key),e})(t)),this.container=C("div","gigasheet-contextmenu"),this.container.oncontextmenu=t=>t.preventDefault(),this.container.style.display="none",this.menuItems))this.container.appendChild(t);this.container.onclick=t=>{if(t.target.hasAttribute("data-key")){let e=t.target.getAttribute("data-key");this.clickCb&&this.clickCb(e),this.hide()}}}onClick(t){this.clickCb=t}hide(){this.container.style.display="none"}setPosition(t,e,i){let{width:s,height:l}=i,o=this.container.getBoundingClientRect().width,n=t;s-t<=o&&(n-=o),this.container.style.left=`${n}px`,e>l/2?(this.container.style.bottom=`${l-e}px`,this.container.style.maxHeight=`${e}px`,this.container.style.top="auto"):(this.container.style.top=`${e}px`,this.container.style.maxHeight=`${l-e}px`,this.container.style.bottom="auto"),this.container.style.display=""}}class y{constructor(t,e,i){this.wrapper=t||document.createElement("div");let s=document.createElement("div");this._container=s,s.style.width="100%",s.style.height="100%",s.style.display="flex",s.style.flexDirection="column",s.innerHTML=`
        ${m}
        <div id="grid-container" class="grid-container">
            <div id="corner-cell" class="corner-cell"></div>
            <div id="header-container" class="header-container"></div>
            <div id="row-number-container" class="row-number-container"></div>
            <div id="selection-layer" class="selection-layer"></div>
        </div>
        `,this.container=s.querySelector(".grid-container"),this.wrapper.appendChild(s),this.ctxmenu=new R,s.append(this.ctxmenu.container),this.container.style.width="100%",this.container.style.position="relative",this.container.style.overflow="auto",this.container.scrollLeft=0,this.container.scrollTop=0,this.headerContainer=s.querySelector(".header-container"),this.rowNumberContainer=s.querySelector(".row-number-container"),this.cornerCell=s.querySelector(".corner-cell"),this.selectionLayer=s.querySelector(".selection-layer"),this.mergeButton=s.querySelector(".merge-button"),this.formatButton=s.querySelector(".format-button"),this.lastDevicePixelRatio=window.devicePixelRatio,this.lastBlockCanvases=this.blockCanvases(),this.cellWidth=e.cellWidth??64,this.cellHeight=e.cellHeight??20,this.blockRows=e.blockRows??28,this.blockCols=e.blockCols??30,this.paddingBlocks=e.paddingBlocks??1,this.padding=e.padding||1,this.MAX_HISTORY_SIZE=100,this.rowNumberWidth=42,this.headerRowHeight=this.cellHeight||30,this.headerContainer.style.lineHeight=`${this.headerRowHeight}px`,this.selectionLayer.style.top=`${this.headerRowHeight}px`,this.selectionLayer.style.left=`${this.rowNumberWidth}px`,this.rowNumberContainer.style.width=`${this.rowNumberWidth}px`,this.rowNumberContainer.style.lineHeight=`${this.headerRowHeight}px`,this.cornerCell.style.width=`${this.rowNumberWidth}px`,this.cornerCell.style.height=`${this.headerRowHeight}px`,this.cornerCell.style.marginTop=`-${this.headerRowHeight+1}px`,e.subscribeFinance&&this.subscribeFinance(),this.mergedCells=e.mergedCells||[],this.heightOverrides=this.buildOverrides(e.heightOverrides),this.widthOverrides=this.buildOverrides(e.widthOverrides),this.gridlinesOn=e.gridlinesOn??!0,this.activeBlocks=new Map,this.undoStack=[],this.redoStack=[],this.elRegistry={},this.heightAccum=[],this.widthAccum=[],this.isResizing=!1,this.resizeStart=null,this.resizeInitialSize=null,this.busy=!1,this.selectedCell=null,this.isSelecting=!1,this.selectionStart=null,this.selectionEnd=null,this.selectionHandle=null,this.draggingHeader=null,this.selectedCols=new Set,this.selectedRows=new Set,this.visibleStartRow=0,this.visibleEndRow=0,this.visibleStartCol=0,this.visibleEndCol=0,this.initEventListeners(),this.createSelectionHandle(),this.addNewSelection(),this.editInput=document.createElement("input"),this.editInput.className="cell-edit-input",this.editInput.style.position="absolute",this.editInput.style.display="none",this.container.appendChild(this.editInput),this.initRender(),this.data=null,this.parser=null,this.setData(new r,e.initialCells)}initRender(){this.updateGridDimensions(),this.renderHeaders(),this.renderRowNumbers(),this.updateVisibleGrid()}buildOverrides(t){if(!t)return[];let e=[];for(let i in t)e[i]=t[i];return e}subscribeFinance(){let t=new f;t.listenYA(["API","^GSPC","^DJI","^IXIC","^RUT","CL=F","GC=F","NVDA","GME","RKT","GAP","BLD","IBP"]),t.onTick(t=>{let e=c[t.id]||{};for(let t in e){let[e,i]=t.split(",");this.renderCell(e,i)}console.log("gigasheet::ontick",t)})}initEventListeners(){this.container.addEventListener("scroll",()=>{requestAnimationFrame(()=>this.handleScroll())}),new ResizeObserver(()=>{this.updateGridDimensions(),this.updateVisibleGrid(),this.updateSelection(),this.updateRenderingQuality()}).observe(this.container),this.container.addEventListener("mousedown",this.handleMouseDown.bind(this)),document.addEventListener("mousemove",this.handleMouseMove.bind(this)),document.addEventListener("mouseup",this.handleMouseUp.bind(this)),this.container.addEventListener("dblclick",this.handleCellDblClick.bind(this)),document.addEventListener("keydown",this.handleKeyDown.bind(this)),document.addEventListener("copy",t=>{if(this.editingCell||!this.selectionBoundRect)return;let{startRow:e,startCol:i,endRow:s,endCol:l}=this.selectionBoundRect,o="";for(let t=e;t<=s;t++){for(let e=i;e<=l;e++)o+=this.getCellText(t,e),e<l&&(o+="	");t<s&&(o+="\n")}t.clipboardData.setData("text/plain",o),t.preventDefault()}),this.container.addEventListener("contextmenu",t=>{!(t.target.closest(".row-number-container")||t.target.closest(".header-container")||t.target.closest(".corner-cell"))&&(t.target.closest(".cell-edit-input")||t.preventDefault())}),this._container.querySelector(".align-button-group")?.addEventListener("click",t=>{let e=t.target?.getAttribute("data-align"),i=this.getSelectedCells();this.setCells(i,"textAlign",e)}),this._container.querySelector(".quick-text-actions-buttons")?.addEventListener("click",async t=>{let e=t.target?.getAttribute("data-action");if("copy"===e)document.execCommand("copy");else if("paste"===e){let t=await navigator.clipboard.readText();this.handlePaste(t)}else"cut"===e&&(document.execCommand("copy"),this.clearSelectedCells())}),document.addEventListener("paste",t=>{this.editingCell||(this.handlePaste(t.clipboardData.getData("text/plain")),t.preventDefault())}),this.mergeButton.onclick=t=>{t.preventDefault(),this.mergeSelectedCells()},this.formatButton.onclick=t=>{t.preventDefault(),this.openFormatMenu()},this.ctxmenu.onClick(async t=>{if("copy"===t)document.execCommand("copy");else if("cut"===t)document.execCommand("copy"),this.clearSelectedCells();else if("paste"===t){if(this.editingCell)return;let t=await navigator.clipboard.readText();this.handlePaste(t)}else"insert-row"===t?this.insertRow():"insert-column"===t?this.insertCol():"delete-row"===t?this.deleteRow():"delete-column"===t?this.deleteCol():"clear"===t?this.clearSelectedCells():"toggle-gridlines"===t?(this.toggleGridlines(),this.forceRerender()):"merge"===t?this.mergeSelectedCells():"unmerge"===t&&this.unmergeSelectedCells()})}showContextMenu(t,e,i,s){let l=this.container.getBoundingClientRect();this.ctxmenu.setPosition(t,e,l),this.rowColInBounds(i,s,this.selectionBoundRect)||this.selectCell({row:i,col:s})}deleteRow(t=null,e=!0){if(null==(t=null!=t?t:this.selectionStart?.row))return;for(let[e,i]of function(t){let e=[];return!function i(s,l=0,o=!1){let n={};if(2===l)for(let i in s){let l=s[i];if(i>t&&(n[parseInt(i)-1]=s[i],delete s[i]),o)for(let t in l)e.push([i,t])}else if(0===l)for(let e in s)e==t?(i(s[e],1,!0),delete s[e]):e>t?(n[parseInt(e)-1]=i(s[e],1,!0),delete s[e]):i(s[e],1);else if(1===l)for(let t in s)i(s[t],2,o);for(let t in n)s[t]=n[t];return s}(h),e}(t)){let t=b(this.getCellText(e,i),"up");this.setText(parseInt(e),parseInt(i),t)}let i=this.data.deleteRow(t);this.mergedCells.forEach(e=>{e.startRow>=t&&(e.startRow--,e.endRow--)});let s=this.heightOverrides[t];delete this.heightOverrides[t],this.shiftHeightOverrides(t,-1),this.updateHeightAccum(),this.renderRowNumbers(),e&&this.recordChanges([{changeKind:"deleteEntireRow",row:t,rowData:i,heightOverride:s}]),this.forceRerender(),this.selectionBoundRect=this.getBoundingRectCells(this.selectionBoundRect.startRow,this.selectionBoundRect.startCol,this.selectionBoundRect.endRow,this.selectionBoundRect.endCol),this.updateSelection()}deleteCol(t=null,e=!0){if(null==(t=null!=t?t:this.selectionStart?.col))return;for(let[e,i]of function(t){let e=[];return!function i(s,l=0,o,n){let r={};if(0===l||2===l)for(let t in s)i(s[t],l+1,o,t);else if(1===l)for(let e in s)e==t?(i(s[e],2,!0),delete s[e]):e>=t?(r[parseInt(e)-1]=i(s[e],2,!0,null),delete s[e]):i(s[e],2);else if(3===l)for(let i in s)i>=t&&(r[parseInt(i)-1]=!0,delete s[i]),o&&e.push([n,i]);for(let t in r)s[t]=r[t];return s}(h),e}(t)){let t=b(this.getCellText(e,i),"left");this.setText(parseInt(e),parseInt(i),t)}let i=this.data.deleteCol(t);this.mergedCells.forEach(e=>{e.startCol>=t&&(e.startCol--,e.endCol--)});let s=this.widthOverrides[t];delete this.widthOverrides[t],this.shiftWidthOverrides(t,-1),this.updateWidthAccum(),this.renderHeaders(),e&&this.recordChanges([{changeKind:"deleteEntireCol",col:t,colData:i,widthOverride:s}]),this.forceRerender(),this.selectionBoundRect=this.getBoundingRectCells(this.selectionBoundRect.startRow,this.selectionBoundRect.startCol,this.selectionBoundRect.endRow,this.selectionBoundRect.endCol),this.updateSelection()}shiftHeightOverrides(t,e=1){-1===e?this.heightOverrides.splice(t,1):1===e&&(this.heightOverrides.splice(t,0,void 0),delete this.heightOverrides[t])}shiftWidthOverrides(t,e=1){-1===e?this.widthOverrides.splice(t,1):1===e&&(this.widthOverrides.splice(t,0,void 0),delete this.widthOverrides[t])}insertRow(t=null,e=null,i=!0,s=null){if(null!=(t=null!=t?t:this.selectionStart?.row)){for(let[e,i]of function(t){let e=[];return!function i(s,l=0,o=!1){let n={};if(2===l)for(let i in s){let l=s[i];if(i>=t&&(n[parseInt(i)+1]=s[i],delete s[i]),o)for(let t in l)e.push([i,t])}else if(0===l)for(let e in s)e>=t?(n[parseInt(e)+1]=i(s[e],1,!0),delete s[e]):i(s[e],1);else if(1===l)for(let t in s)i(s[t],2,o);for(let t in n)s[t]=n[t];return s}(h),e}(t)){let t=b(this.getCellText(e,i),"down");this.setText(parseInt(e),parseInt(i),t)}this.data.addRow(t,e),this.mergedCells.forEach(e=>{e.startRow>=t&&(e.startRow++,e.endRow++)}),this.shiftHeightOverrides(t,1),null!=s&&(this.heightOverrides[t]=s),this.updateHeightAccum(),this.renderRowNumbers(),i&&this.recordChanges([{changeKind:"insertEntireRow",row:t}]),this.forceRerender(),this.selectionBoundRect=this.getBoundingRectCells(this.selectionBoundRect.startRow,this.selectionBoundRect.startCol,this.selectionBoundRect.endRow,this.selectionBoundRect.endCol),this.updateSelection()}}insertCol(t=null,e=null,i=!0,s=null){if(null!=(t=null!=t?t:this.selectionStart?.col)){for(let[e,i]of function(t){let e=[];return!function i(s,l=0,o,n){let r={};if(0===l||2===l)for(let t in s)i(s[t],l+1,o,t);else if(1===l)for(let e in s)e>=t?(r[parseInt(e)+1]=i(s[e],2,!0,null),delete s[e]):i(s[e],2);else if(3===l)for(let i in s)i>=t&&(r[parseInt(i)+1]=!0,delete s[i]),o&&e.push([n,i]);for(let t in r)s[t]=r[t];return s}(h),e}(t)){let t=b(this.getCellText(e,i),"right");this.setText(parseInt(e),parseInt(i),t)}this.data.addCol(t,e),this.mergedCells.forEach(e=>{e.startCol>=t&&(e.startCol++,e.endCol++)}),this.shiftWidthOverrides(t,1),null!=s&&(this.widthOverrides[t]=s),this.updateWidthAccum(),this.renderHeaders(),i&&this.recordChanges([{changeKind:"insertEntireCol",col:t}]),this.forceRerender(),this.selectionBoundRect=this.getBoundingRectCells(this.selectionBoundRect.startRow,this.selectionBoundRect.startCol,this.selectionBoundRect.endRow,this.selectionBoundRect.endCol),this.updateSelection()}}toggleGridlines(){this.gridlinesOn=!this.gridlinesOn,this.forceRerender()}scaler(){return devicePixelRatio<1?(1+(1-devicePixelRatio))*(1+(1-devicePixelRatio)):1}clearSelectedCells(){if(!this.selectionBoundRect)return;let{startRow:t,startCol:e,endRow:i,endCol:s}=this.selectionBoundRect,l=[],o=[];for(let n=t;n<=i;n++)for(let t=e;t<=s;t++){let e={row:n,col:t,previousValue:this.getCellText(n,t),newValue:"",changeKind:"valchange"};this.clearElRegistry(n,t),o.push([n,t]),l.push(e)}for(let[t,e]of(this.data.deleteCells(o),this.recordChanges(l),o))this.renderCell(t,e)}getColumnName(t){let e="";for(;t>=0&&(e=String.fromCharCode(65+t%26)+e,!((t=Math.floor(t/26)-1)<0)););return e}handlePaste(t){if(!this.selectionBoundRect)return;let{startRow:e,startCol:i}=this.selectionBoundRect,s=t.split("\n"),l=[];for(let t=0;t<s.length;t++){let o=s[t].split("	");for(let s=0;s<o.length;s++){let n=e+t,r=i+s;l.push({row:n,col:r,previousValue:this.getCellText(n,r),newValue:o[s],changeKind:"valchange"}),this.setText(n,r,o[s]),this.renderCell(n,r)}}l.length>0&&this.recordChanges(l)}recordChanges(t){this.redoStack=[],this.undoStack.push(t),this.undoStack.length>this.MAX_HISTORY_SIZE&&this.undoStack.shift()}setWidthOverride(t,e){null==e?delete this.widthOverrides[t]:this.widthOverrides[t]=e}setHeightOverride(t,e){null==e?delete this.heightOverrides[t]:this.heightOverrides[t]=e}undo(){if(0===this.undoStack.length)return;let t=this.undoStack.pop(),e=[],i=[],s=!1;for(let l of t){let{row:t,col:o,previousValue:n,changeKind:r}=l;if("merge"===r)this.unmergeSelectedCells(l.bounds,!1),s=!0,e.push({changeKind:"unmerge",bounds:l.bounds});else if("unmerge"===r)this.mergeSelectedCells(l.bounds,!1),s=!0,e.push({changeKind:"merge",bounds:l.bounds});else if("deleteEntireRow"===r)this.insertRow(l.row,l.rowData,!1,l.heightOverride),s=!0,e.push({changeKind:"deleteEntireRow",row:l.row,rowData:l.rowData,heightOverride:l.heightOverride});else if("deleteEntireCol"===r)this.insertCol(l.col,l.colData,!1,l.widthOverride),s=!0,e.push({changeKind:"deleteEntireCol",col:l.col,colData:l.colData,widthOverride:l.widthOverride});else if("insertEntireRow"===r)this.deleteRow(l.row,!1),s=!0,e.push({changeKind:"insertEntireRow",row:l.row});else if("insertEntireCol"===r)this.deleteCol(l.col,!1),s=!0,e.push({changeKind:"insertEntireCol",col:l.col});else if("widthOverrideUpdate"===r){let t=this.widthOverrides[l.col];this.setWidthOverride(l.col,l.value),this.updateWidthAccum(),this.renderHeaders(),s=!0,e.push({changeKind:"widthOverrideUpdate",col:l.col,value:t})}else if("heightOverrideUpdate"===r){let t=this.heightOverrides[l.row];this.setHeightOverride(l.row,l.value),this.updateHeightAccum(),this.renderRowNumbers(),s=!0,e.push({changeKind:"heightOverrideUpdate",row:l.row,value:t})}else"valchange"===r?(e.push({row:t,col:o,previousValue:this.getCellText(t,o),newValue:n,changeKind:"valchange"}),this.setCell(t,o,"text",n),i.push([t,o])):console.log("UNHANDLED UNDO:",r)}this.redoStack.push(e),s?this.forceRerender():this.rerenderCells(i),this.updateSelection()}rerenderCells(t=[]){for(let[e,i]of t)this.renderCell(e,i);this.rerenderMerges(t)}rerenderMerges(t=[]){let e=new Set;for(let[i,s]of t){let t=this.getMerge(i,s);if(t)for(let i of(e.add(t),this.getBlocksInMerge(t)))this.renderCell(t.startRow,t.startCol,i)}}redo(){if(0===this.redoStack.length)return;let t=this.redoStack.pop(),e=[],i=[],s=!1;for(let l of t){let{row:t,col:o,newValue:n,previousValue:r,changeKind:a}=l;if("unmerge"===a)this.mergeSelectedCells(l.bounds,!1),s=!0,e.push({changeKind:"merge",bounds:l.bounds});else if("merge"===a)this.unmergeSelectedCells(l.bounds,!1),s=!0,e.push({changeKind:"unmerge",bounds:l.bounds});else if("deleteEntireRow"===a)this.deleteRow(l.row,!1),s=!0,e.push({changeKind:"deleteEntireRow",row:l.row,rowData:l.rowData,heightOverride:l.heightOverride});else if("deleteEntireCol"===a)this.deleteCol(l.col,!1),s=!0,e.push({changeKind:"deleteEntireCol",col:l.col,colData:l.colData,widthOverride:l.widthOverride});else if("insertEntireRow"===a)this.insertRow(l.row,null,!1),s=!0,e.push({changeKind:"insertEntireRow",row:l.row});else if("insertEntireCol"===a)this.insertCol(l.col,null,!1),s=!0,e.push({changeKind:"insertEntireCol",col:l.col});else if("widthOverrideUpdate"===a){let t=this.widthOverrides[l.col];this.setWidthOverride(l.col,l.value),this.updateWidthAccum(),this.renderHeaders(),s=!0,e.push({changeKind:"widthOverrideUpdate",col:l.col,value:t})}else if("heightOverrideUpdate"===a){let t=this.heightOverrides[l.row];this.setHeightOverride(l.row,l.value),this.updateHeightAccum(),this.renderRowNumbers(),s=!0,e.push({changeKind:"heightOverrideUpdate",row:l.row,value:t})}else"valchange"===a?(e.push({row:t,col:o,previousValue:this.getCellText(t,o),newValue:n,changeKind:"valchange"}),this.setCell(t,o,"text",r),i.push([t,o])):console.log("UNHANDLED REDO:",a)}this.undoStack.push(e),s?this.forceRerender():this.rerenderCells(i),this.updateSelection()}rowColInBounds(t,e,i){return null!=i&&t<=i.endRow&&t>=i.startRow&&e<=i.endCol&&e>=i.startCol}hideContextMenu(){this.ctxmenu.hide()}handleCellDblClick(t){if(t.target===this.editInput)return;let{row:e,col:i}=this.getCellFromEvent(t);-1!==e&&-1!==i&&this.startCellEdit(e,i)}openFormatMenu(){let{win:t,addListener:e}=function(){let t=window.open("","target=_blank","width=190,height=400");t.document.body.innerHTML=`
        <style>
            .format-menu {
                font-family: Arial, sans-serif;
                width: 220px;
                padding: 12px;
                background: #f8f8f8;
                border: 1px solid #999999;
                border-radius: 4px;
                box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            }
            .menu-section {
                margin-bottom: 12px;
            }
            .menu-title {
                font-weight: bold;
                margin-bottom: 6px;
                color: #555;
                font-size: 13px;
            }
            select, input {
                width: 100%;
                padding: 6px;
                border: 1px solid #ccc;
                border-radius: 3px;
                margin-bottom: 8px;
            }
            .color-options {
                display: flex;
                gap: 4px;
                margin-top: 6px;
            }
            .color-option {
                width: 20px;
                height: 20px;
                border-radius: 3px;
                cursor: pointer;
                border: 1px solid #999999;
            }
            .format-btn {
                flex: 1;
                padding: 6px;
                background: white;
                border: 1px solid #ccc;
                border-radius: 3px;
                cursor: pointer;
                text-align: center;
                font-size: 12px;
            }
            .format-btn:hover {
                background: #f0f0f0;
            }
            .format-btn.active {
                background: #999999;
                border-color: #999;
            }
            .color-option:hover {
                border-color: #999;
            }
            .alignment-options,.border-options {
                display: flex;
                gap: 4px;
            }
            .alignment-btn,.border-btn {
                flex: 1;
                padding: 6px;
                background: white;
                border: 1px solid #ccc;
                border-radius: 3px;
                cursor: pointer;
                text-align: center;
            }
            .alignment-btn:hover,.border-btn:hover {
                background: #f0f0f0;
            }
            .alignment-btn.active,.border-btn.active {
                background: #999999;
                border-color: #999;
            }
            .baseline-visual {
                display: inline-block;
                width: 100%;
                height: 40px;
                position: relative;
                margin-top: 8px;
                border: 1px solid #eee;
                background: repeating-linear-gradient(
                    to bottom,
                    #f8f8f8,
                    #f8f8f8 1px,
                    #fff 1px,
                    #fff 10px
                );
            }
            .baseline-line {
                position: absolute;
                left: 0;
                right: 0;
                height: 1px;
                background-color: red;
            }
            .baseline-text {
                position: absolute;
                left: 50%;
                transform: translateX(-50%);
                white-space: nowrap;
            }
        </style>
        <div class="format-menu">
            <div class="menu-section">
                <div class="menu-title">Cell Type</div>
                <select id="cellType">
                    <option value="text" selected>Text</option>
                    <option value="button">Button</option>
                    <option value="linechart">Line Chart</option>
                </select>
            </div>
            <div class="menu-section">
                <div class="menu-title">Font Size</div>
                <select id="fontSize">
                    <option value="8">8</option>
                    <option value="10" selected>10</option>
                    <option value="12">12</option>
                    <option value="14">14</option>
                    <option value="16">16</option>
                    <option value="18">18</option>
                    <option value="20">20</option>
                    <option value="24">24</option>
                </select>
            </div>
            <div class="menu-section">
                <div class="menu-title">Font Color</div>
                <input type="color" id="fontColor" value="#000000">
                <div class="color-options">
                    <div class="color-option" style="background: #000000;" data-color="#000000"></div>
                    <div class="color-option" style="background: #ff0000;" data-color="#ff0000"></div>
                    <div class="color-option" style="background: #00aa00;" data-color="#00aa00"></div>
                    <div class="color-option" style="background: #0000ff;" data-color="#0000ff"></div>
                    <div class="color-option" style="background: #ff9900;" data-color="#ff9900"></div>
                </div>
            </div>
            <div class="menu-section">
                <div class="menu-title">Text Alignment</div>
                <div class="alignment-options">
                    <div class="alignment-btn" data-align="left" title="Align Left">\u{23A1}</div>
                    <div class="alignment-btn" data-align="center" title="Align Center">\u{23A2}</div>
                    <div class="alignment-btn" data-align="right" title="Align Right">\u{23A3}</div>
                </div>
            </div>
            <div class="menu-section">
                <div class="menu-title">Borders</div>
                <div class="border-options">
                    <div class="border-btn" data-border="2" title="Border Left">Left</div>
                    <div class="border-btn" data-border="4" title="Border Top">Top</div>
                    <div class="border-btn" data-border="8" title="Border Right">Right</div>
                    <div class="border-btn" data-border="16" title="Border Bottom">Bottom</div>
                </div>
            </div>
            <div class="menu-section">
            <div class="menu-title">Text Baseline</div>
                <div class="option-group">
                    <div class="format-btn" data-baseline="alphabetic" title="Alphabetic">A</div>
                    <div class="format-btn" data-baseline="top" title="Top">Top</div>
                    <div class="format-btn" data-baseline="middle" title="Middle">Mid</div>
                    <div class="format-btn" data-baseline="bottom" title="Bottom">Bot</div>
                </div>
                <div class="baseline-visual" id="baselineDemo">
                    <div class="baseline-line" id="baselineIndicator"></div>
                    <div class="baseline-text" id="baselineText">Text</div>
                </div>
            </div>
        </div>
    `;let e=[];function i(t,i){for(let s of e)s(t,i)}return t.document.title="Format Menu",t.document.getElementById("fontSize").addEventListener("change",function(){i("fontSize",this.value)}),t.document.getElementById("cellType").addEventListener("change",function(){i("cellType",this.value)}),t.document.getElementById("fontColor").addEventListener("input",function(){i("color",this.value)}),t.document.querySelectorAll(".color-option").forEach(e=>{e.addEventListener("click",function(){let e=this.getAttribute("data-color");t.document.getElementById("fontColor").value=e,i("color",e)})}),t.document.querySelectorAll(".alignment-btn").forEach(function(e){e.addEventListener("click",function(){t.document.querySelectorAll(".alignment-btn").forEach(function(t){t.classList.remove("active")}),this.classList.add("active"),i("textAlign",this.getAttribute("data-align"))})}),t.document.querySelectorAll(".border-btn").forEach(function(e){e.addEventListener("click",function(){this.classList.toggle("active");let e=0;t.document.querySelectorAll(".border-btn.active").forEach(function(t){let i=t.getAttribute("data-border");e|=i}),i("border",e)})}),t.document.querySelectorAll("[data-baseline]").forEach(function(e){let s={alphabetic:{position:30,description:"Normal text baseline"},top:{position:5,description:"Top of the em square"},middle:{position:20,description:"Middle of the em square"},bottom:{position:35,description:"Bottom of the em square"},hanging:{position:5,description:"Hanging baseline (like Hindi)"},ideographic:{position:35,description:"Ideographic baseline (like CJK)"}};e.addEventListener("click",function(){t.document.querySelectorAll("[data-baseline]").forEach(t=>t.classList.remove("active")),this.classList.add("active");let e=this.getAttribute("data-baseline");t.document.getElementById("baselineDemo");let l=t.document.getElementById("baselineIndicator"),o=t.document.getElementById("baselineText");if(s[e]){let t=s[e].position;l.style.top=`${t}px`,o.style.top=`${t}px`,o.textContent=e}i("textBaseline",e)})}),{win:t,addListener:t=>e.push(t)}}();e((t,e)=>{let i=this.getSelectedCells();this.setCells(i,t,e)})}forceRerender(){this.updateVisibleGrid(!0)}handleKeyDown(t){let e=t.key.toLowerCase();if("f2"===e&&this.selectionStart){if(t.preventDefault(),this.editingCell)return;this.startCellEdit(this.selectionStart.row,this.selectionStart.col)}else if("f3"===e){if(this.editingCell)return;this.openFormatMenu(),t.preventDefault()}else if("escape"===e&&"none"!==this.editInput.style.display)this.cancelCellEdit();else if("delete"===e){if(this.editingCell)return;this.clearSelectedCells()}else if("x"===e&&t.ctrlKey){if(this.editingCell)return;document.execCommand("copy"),this.clearSelectedCells()}else if("s"===e&&t.ctrlKey){if(this.editingCell)return;let e=this.data.save(),i={mergedCells:this.mergedCells,heightOverrides:this.heightOverrides,widthOverrides:this.widthOverrides,gridlinesOn:this.gridlinesOn,data:e};localStorage.setItem("sheet-state",JSON.stringify(i)),t.preventDefault()}else if("l"===e&&t.ctrlKey){if(this.editingCell)return;this.restoreSave(),t.preventDefault()}else if(t.ctrlKey||t.metaKey){if(this.editingCell)return;"y"===e||t.shiftKey&&"z"===e?(t.preventDefault(),this.redo()):"z"===e&&(t.preventDefault(),this.undo())}else if("arrowup"===e||"arrowdown"===e||"arrowleft"===e||"arrowright"===e||"enter"===e){if(!this.selectionEnd||this.editingCell)return;t.preventDefault(),this.handleArrowKeyDown(t)}else if(this.selectionStart&&t.key?.length===1){if(this.editingCell)return;this.startCellEdit(this.selectionStart.row,this.selectionStart.col,t.key)}}restoreSave(){let t=localStorage.getItem("sheet-state");if(t){try{if(!(t=JSON.parse(t)))return!1}catch{return!1}this.widthOverrides=t.widthOverrides,this.heightOverrides=t.heightOverrides,this.mergedCells=t.mergedCells,this.gridlinesOn=t.gridlinesOn;let e=new r;return e.restore(t.data),this.setData(e),this.updateSelection(),!0}return!1}handleArrowKeyDown(t){if(!this.selectionEnd||!this.selectionStart)return;let e={ArrowUp:[-1,0],ArrowDown:[1,0],ArrowLeft:[0,-1],ArrowRight:[0,1],Enter:t.shiftKey?[-1,0]:[1,0]},i=this.getMerge(this.selectionEnd.row,this.selectionEnd.col),s=this.selectionEnd.row+e[t.key][0],l=this.selectionEnd.col+e[t.key][1],o=this.getMerge(s,l);if(t.shiftKey){let e=JSON.stringify(this.selectionBoundRect);if("ArrowUp"===t.key||"Enter"===t.key&&t.shiftKey)for(;s>0&&e===JSON.stringify(this.getBoundingRectCells(this.selectionStart.row,this.selectionStart.col,s,l));)s--;else if("ArrowDown"!==t.key&&("Enter"!==t.key||t.shiftKey)){if("ArrowLeft"===t.key)for(;l>0&&e===JSON.stringify(this.getBoundingRectCells(this.selectionStart.row,this.selectionStart.col,s,l));)l--;else if("ArrowRight"===t.key)for(;l<this.getTotalCols()&&e===JSON.stringify(this.getBoundingRectCells(this.selectionStart.row,this.selectionStart.col,s,l));)l++}else for(;s<this.getTotalRows()&&e===JSON.stringify(this.getBoundingRectCells(this.selectionStart.row,this.selectionStart.col,s,l));)s++}else o&&o===i&&("ArrowUp"===t.key?s=o.startRow-1:"ArrowDown"===t.key||"Enter"===t.key?s=o.endRow+1:"ArrowLeft"===t.key?l=o.startCol-1:"ArrowRight"===t.key&&(l=o.endCol+1));s=Math.min(s=Math.max(0,s),this.totalRowBounds-1),l=Math.min(l=Math.max(0,l),this.totalColBounds-1),t.shiftKey&&"Enter"!==t.key&&(this.selectionEnd={row:s,col:l}),this.selectCell({row:s,col:l,continuation:t.shiftKey&&"Enter"!==t.key})}inVisibleBounds(t,e){let{row:i,col:s}=this.getTopLeftBounds(),{row:l,col:o}=this.getBottomRightBounds();return t>=s&&t<=l&&e>=s&&e<=o}scrollTo(t,e,i){let s,l,o;if(t<0||t>=this.totalRows||e<0||e>=this.totalCols)return;let n=this.getMerge(t,e);n?(s=this.getWidthOffset(n.startCol,!0),l=this.getHeightOffset(n.startRow,!0),o=this.getMergeWidth(n),this.getMergeHeight(n),this.getCellText(n.startRow,n.startCol)):(s=this.getWidthOffset(e,!0),l=this.getHeightOffset(t,!0),o=this.getCellWidth(t,e),this.rowHeight(t),this.getCellText(t,e)),"ArrowUp"===i?this.container.scrollTo({top:l-100,behavior:"smooth"}):"ArrowDown"===i?this.container.scrollTo({top:l,behavior:"smooth"}):"ArrowLeft"==i?this.container.scrollTo({left:s,behavior:"smooth"}):"ArrowRight"===i&&this.container.scrollTo({left:s-this.container.clientWidth-o,behavior:"smooth"})}getSelectedCells(){if(!this.selectionBoundRect)return[];let{startRow:t,startCol:e,endRow:i,endCol:s}=this.selectionBoundRect;return this.data.getCellsForce(t,e,i,s).filter(t=>this.isValid(t.row,t.col))}isValid(t,e){let i=this.getMerge(t,e);return!i||i.startRow==t&&i.startCol==e}getTotalRows(){return this.totalRows}getTotalCols(){return this.totalCols}get totalRows(){return Math.max(this.data?.rowCount||0,this.blockRows)+this.blockRows*this.padding}get totalCols(){return Math.max(this.data?.colCount||0,this.blockCols)+this.blockCols*this.padding}getMerge(t,e){return this.mergedCells.find(i=>t>=i.startRow&&t<=i.endRow&&e>=i.startCol&&e<=i.endCol)}getMergeWidth(t){return this.getWidthBetweenColumns(t.startCol,t.endCol+1)}getMergeHeight(t){return this.getHeightBetweenRows(t.startRow,t.endRow+1)}startCellEdit(t,e,i){let s,l,o,n,r;if(t<0||t>this.totalRowBounds||e<0||e>this.totalColBounds)return;let a=this.getMerge(t,e);a?(s=this.getWidthOffset(a.startCol,!0),l=this.getHeightOffset(a.startRow,!0),o=this.getMergeWidth(a),n=this.getMergeHeight(a),r=null!=i?"":this.getCellText(a.startRow,a.startCol),t=a.startRow,e=a.startCol):(s=this.getWidthOffset(e,!0),l=this.getHeightOffset(t,!0),o=this.getCellWidth(t,e),n=this.rowHeight(t),r=null!=i?"":this.getCellText(t,e)),this.editInput.value=r,this.editInput.style.left=`${s}px`,this.editInput.style.top=`${l}px`,this.editInput.style.minWidth=`${o}px`,this.editInput.style.width=r.length+1+"ch",this.editInput.style.height=`${n}px`,this.editInput.style.display="block",this.editInput.focus(),this.editingCell={row:t,col:e},this.editInput.onblur=this.finishCellEdit.bind(this),this.editInput.onkeydown=t=>{"Enter"===t.key?this.finishCellEdit():this.editInput.style.width=this.editInput.value.length+1+"ch"}}setText(t,e,i){this.setCell(t,e,"text",i)}setCell(t,e,i,s){let l=this.getCell(t,e);l&&(l[i]=s,this.data.has(t,e)||this.data.set(t,e,l))}setCells(t,e,i){for(let s of t)this.setCell(s.row,s.col,e,i),this.renderCell(s.row,s.col);"cellType"===e&&(console.log("forcing rerender"),this.forceRerender())}finishCellEdit(){if(!this.editingCell)return;let{row:t,col:e}=this.editingCell;if(this.editInput.value===this.getCellText(t,e))return void this.cancelCellEdit();this.recordChanges([{row:t,col:e,previousValue:this.getCellText(t,e),newValue:this.editInput.value,changeKind:"valchange"}]),this.setText(t,e,this.editInput.value),this.cancelCellEdit();let i=this.getMerge(t,e);if(i)for(let t of this.getBlocksInMerge(i))this.renderCell(i.startRow,i.startCol,t);else this.renderCell(t,e)}getBlocksInMerge(t){let e=new Set;for(let i=t.startRow;i<=t.endRow;i++)for(let s=t.startCol;s<=t.endCol;s++){let t=this.getBlockOrSubBlock(i,s);t&&(e.has(t)||e.add(t))}return e}cancelCellEdit(){this.editInput.style.display="none",this.editingCell=null,this.editInput.onblur=null,this.editInput.onkeydown=null}updateRenderingQuality(){this.lastBlockCanvases!==this.blockCanvases()?(console.log("RESIZE"),this.lastBlockCanvases=this.blockCanvases(),this.forceRerender()):Math.abs(window.devicePixelRatio-this.lastDevicePixelRatio)>0&&(this.lastDevicePixelRatio=window.devicePixelRatio,console.log("update render quality"),requestAnimationFrame(()=>{this.busy||(this.rqtimeout&&clearTimeout(this.rqtimeout),this.rqtimeout=setTimeout(()=>{this.busy=!0,this.activeBlocks.forEach(t=>{t.subBlocks.length<2?this.renderBlock(t,!0):t.subBlocks.forEach(t=>{this.renderBlock(t,!0)})}),this.busy=!1,this.rqtimeout=null},200))}))}createSelectionHandle(){this.selectionHandle=document.createElement("div"),this.selectionHandle.className="selection-handle bottom-right",this.selectionHandle.style.display="none",this.selectionLayer.appendChild(this.selectionHandle),this.selectionHandle.addEventListener("mousedown",t=>{t.stopPropagation(),this.selectedCell&&(this.isResizing=!0,this.resizeStart={x:t.clientX,y:t.clientY},this.resizeInitialSize={width:this.selectedCell.offsetWidth,height:this.selectedCell.offsetHeight})})}handleMouseDown(t){if(t.target.closest(".header-cell")||t.target.closest(".row-number-container")||t.target.closest(".corner-cell"))return void this.hideContextMenu();if(t.target!==this.container&&t.target!==this.editInput&&!this.draggingHeader){if(t.target===this.ctxmenu.container||this.ctxmenu.container.contains(t.target)||this.hideContextMenu(),2===t.button){let e=t.clientX,i=t.clientY,{row:s,col:l}=this.getCellFromEvent(t);this.showContextMenu(e,i,s,l);return}0===t.button&&this.handleSelectionMouseDown(t)}}handleSelectionMouseDown(t){let{row:e,col:i}=this.getCellFromEvent(t);t.ctrlKey&&this.selectionStart?(this.selectionStart=null,this.selectionEnd=null,this.selectionBoundRect=null,this.isSelecting=!0,this.addNewSelection(),this.selectCell({row:e,col:i})):t.shiftKey&&this.selectionStart?(this.isSelecting=!0,this.selectCell({row:e,col:i,continuation:!0})):(this.isSelecting=!0,this.selectCell({row:e,col:i,clear:!0}))}selectCell({row:t,col:e,continuation:i=!1,clear:s=!1}){-1!==t&&-1!==e&&(s&&(this.selectionLayer.innerHTML="",this.addNewSelection()),this.activeSelection||this.addNewSelection(),i||(this.selectionStart={row:t,col:e}),this.selectionEnd={row:t,col:e},this.selectionStart&&(this.selectionBoundRect=this.getBoundingRectCells(this.selectionStart.row,this.selectionStart.col,t,e),this.updateSelection()))}getCellsInRange(t,e,i,s){let l=[];for(let o=t;o<=i;o++)for(let t=e;t<=s;t++)l.push(this.getCell(o,t));return l}getMergesInRange({startRow:t,startCol:e,endRow:i,endCol:s}){let l=new Set;for(let o=t;o<=i;o++)for(let t=e;t<=s;t++){let e=this.getMerge(o,t);e&&l.add(e)}return[...l.values()]}normalizeCoordinates({startRow:t,startCol:e,endRow:i,endCol:s}){return{startRow:Math.min(t,i),startCol:Math.min(e,s),endRow:Math.max(t,i),endCol:Math.max(e,s)}}getBoundingRectCells(t,e,i,s){({startRow:t,startCol:e,endRow:i,endCol:s}=this.normalizeCoordinates({startRow:t,startCol:e,endRow:i,endCol:s}));let l=this.getMergesInRange({startRow:t,startCol:e,endRow:i,endCol:s});if(0===l.length)return{startRow:t,startCol:e,endRow:i,endCol:s};for(let o of l)t=Math.min(t,o.startRow),e=Math.min(e,o.startCol),i=Math.max(i,o.endRow),s=Math.max(s,o.endCol);return{startRow:t,startCol:e,endRow:i,endCol:s}}handleMouseMove(t){if(this.draggingHeader){let e=this.container.scrollLeft;this.draggingHeader.el.style.left=`${e+t.clientX-8}px`}else if(this.draggingRow){let e=this.container.scrollTop,i=this.container.getBoundingClientRect();this.draggingRow.el.style.top=`${e+t.clientY-this.headerRowHeight-i.y-5}px`}else if(this.isSelecting){let{row:e,col:i}=this.getCellFromEvent(t);if(-1!==e&&-1!==i){if(this.selectionEnd={row:e,col:i},!this.selectionStart)return;this.selectionBoundRect=this.getBoundingRectCells(this.selectionStart.row,this.selectionStart.col,e,i),this.updateSelection()}}else if(this.isResizing){let e=t.clientX-this.resizeStart.x,i=t.clientY-this.resizeStart.y,s=Math.max(this.cellWidth,this.resizeInitialSize.width+e),l=Math.max(this.cellHeight,this.resizeInitialSize.height+i);if(!this.selectedCell)return;this.selectedCell.style.width=`${s}px`,this.selectedCell.style.height=`${l}px`,this.positionSelectionHandle()}}handleMouseUp(t){if(this.isSelecting){this.isSelecting=!1;let{row:e,col:i}=this.getCellFromEvent(t);if(-1!==e&&-1!==i){if(!this.selectionStart)return;this.selectionEnd={row:e,col:i},this.getBoundingRectCells(this.selectionStart.row,this.selectionStart.col,e,i),this.updateSelection()}}else if(this.isResizing)this.isResizing=!1;else if(this.draggingHeader){let e=this.draggingHeader,i=this.draggingHeader.col;this.draggingHeader=null;let s=this.container.scrollLeft+t.clientX-this.getWidthOffset(i+1,!0),l=this.widthOverrides[i],o=this.widthOverrides[i]?this.widthOverrides[i]+s:this.getCellWidth(i)+s;if(o<=1){e.el.style.left=e.origLeft;return}this.setWidthOverride(i,o),this.recordChanges([{changeKind:"widthOverrideUpdate",col:i,value:l}]),this.updateWidthAccum(),this.renderHeaders(),this.forceRerender(),this.updateSelection(),t.stopPropagation()}else if(this.draggingRow){let e=this.draggingRow,i=this.draggingRow.row;this.draggingRow=null;let s=this.container.scrollTop,l=this.container.getBoundingClientRect(),o=s+t.clientY-l.y-this.getHeightOffset(i+1,!0),n=this.heightOverrides[i],r=this.heightOverrides[i]?this.heightOverrides[i]+o:this.getCellHeight(i)+o;if(r<=1){e.el.style.top=e.origTop;return}this.setHeightOverride(i,r),this.recordChanges([{changeKind:"heightOverrideUpdate",row:i,value:n}]),this.updateHeightAccum(),this.renderRowNumbers(),this.forceRerender(),this.updateSelection(),t.stopPropagation()}}getColWidth(t){return this.widthOverrides[t]??this.cellWidth}getTopLeftBounds(){let t=this.container.getBoundingClientRect(),e=this.container.scrollLeft,i=this.container.scrollTop,s=Math.max(0,this.rowNumberWidth+8-e)-t.left+e-this.rowNumberWidth,l=this.headerRowHeight+8-t.top+i-this.headerRowHeight;if(s<0||l<0)return{row:-1,col:-1};let o=this.bsearch(this.widthAccum,s+this.rowNumberWidth)-1;return{row:Math.min(this.bsearch(this.heightAccum,l+this.headerRowHeight)-1,this.totalRowBounds-1),col:Math.min(o,this.totalColBounds-1)}}getBottomRightBounds(){let t=this.container.getBoundingClientRect(),e=this.container.scrollLeft,i=this.container.scrollTop,s=t.right-t.left+e-(this.rowNumberWidth+8),l=t.bottom-t.top+i-this.headerRowHeight;if(s<0||l<0)return{row:-1,col:-1};let o=this.bsearch(this.widthAccum,s+this.rowNumberWidth)-1;return{row:Math.min(this.bsearch(this.heightAccum,l+this.headerRowHeight)-1,this.totalRowBounds-1),col:Math.min(o,this.totalColBounds-1)}}bsearch(t,e){let i=0,s=t.length-1;for(;i<s;){let l=Math.floor(i+(s-i)/2);e<t[l]?s=l:i=l+1}return i}getCellFromEvent(t){let e=this.container.getBoundingClientRect(),i=this.container.scrollLeft,s=this.container.scrollTop,l=t.clientX-e.left+i-this.rowNumberWidth,o=t.clientY-e.top+s-this.headerRowHeight;if(l<0||o<0)return{row:-1,col:-1};let n=this.bsearch(this.widthAccum,l+this.rowNumberWidth)-1;return{row:Math.min(this.bsearch(this.heightAccum,o+this.headerRowHeight)-1,this.totalRowBounds-1),col:Math.min(n,this.totalColBounds-1)}}mergeSelectedCells(t=null,e=!0){if(!this.selectionStart||!this.selectionEnd)return;let i=this.selectionStart.row,s=this.selectionStart.col,l=this.selectionEnd.row,o=this.selectionEnd.col;t&&(i=t.startRow,s=t.startCol,l=t.endRow,o=t.endCol);let n=Math.min(i,l),r=Math.max(i,l),a=Math.min(s,o),h=Math.max(s,o);for(let t of this.mergedCells)if(n<=t.endRow&&r>=t.startRow&&a<=t.endCol&&h>=t.startCol)return void alert("Cannot merge cells that overlap with existing merged cells.");this.mergedCells.push({startRow:n,endRow:r,startCol:a,endCol:h}),e&&this.recordChanges([{changeKind:"merge",bounds:{startRow:n,endRow:r,startCol:a,endCol:h}}]),e&&this.forceRerender()}unmergeSelectedCells(t=null,e=!0){let i;if(!this.selectionStart||!this.selectionEnd)return;let s=this.selectionStart.row,l=this.selectionStart.col,o=this.selectionEnd.row,n=this.selectionEnd.col;t&&(s=t.startRow,l=t.startCol,o=t.endRow,n=t.endCol);let r=Math.min(s,o),a=Math.max(s,o),h=Math.min(l,n),d=Math.max(l,n);for(let t=0;t<this.mergedCells.length;t++)r<=(i=this.mergedCells[t]).endRow&&a>=i.startRow&&h<=i.endCol&&d>=i.startCol&&this.mergedCells.splice(t,1);i&&(e&&this.recordChanges([{changeKind:"unmerge",bounds:{startRow:i.startRow,endRow:i.endRow,startCol:i.startCol,endCol:i.endCol}}]),e&&this.forceRerender())}addNewSelection(){let t=document.createElement("div");return this.selectionLayer.appendChild(t),this.activeSelection=t,t}updateSelection(){if(!this.activeSelection||(this.activeSelection.innerHTML="",!this.selectionHandle)||(this.selectionHandle.style.display="none",!this.selectionBoundRect))return;let{startRow:t,startCol:e,endRow:i,endCol:s}=this.selectionBoundRect,l=this.getWidthOffset(e),o=this.getWidthBetweenColumns(e,s+1),n=this.getHeightOffset(t),r=this.getHeightBetweenRows(t,i+1);for(let t of(this.selectedCell=document.createElement("div"),this.selectedCell.className="selected-cell",this.selectedCell.style.left=`${l}px`,this.selectedCell.style.top=`${n}px`,this.selectedCell.style.width=`${o+1}px`,this.selectedCell.style.height=`${r+1}px`,this.activeSelection.appendChild(this.selectedCell),this.positionSelectionHandle(),this.selectionHandle.style.display="block",this.selectedCols))if(t<e||t>s){this.selectedCols.delete(t);let e=this.headerContainer.querySelector(`[data-hccol='${t}']`);if(!e)continue;e.classList.remove("col-selected");let i=e.nextSibling;i&&i.classList.remove("handle-col-selected")}for(let t=e;t<=s;t++){if(t in this.selectedCols)continue;this.selectedCols.add(t);let e=this.headerContainer.querySelector(`[data-hccol='${t}']`);if(!e)continue;e.classList.add("col-selected");let i=e.nextSibling;i&&i.classList.add("handle-col-selected")}for(let e of this.selectedRows)if(e<t||e>i){this.selectedRows.delete(e);let t=this.rowNumberContainer.querySelector(`[data-rnrow='${e}']`);if(!t)continue;t.classList.remove("row-selected");let i=t.nextSibling;i&&i.classList.remove("handle-row-selected")}for(let e=t;e<=i;e++){if(e in this.selectedRows)continue;this.selectedRows.add(e);let t=this.rowNumberContainer.querySelector(`[data-rnrow='${e}']`);if(!t)continue;t.classList.add("row-selected");let i=t.nextSibling;i&&i.classList.add("handle-row-selected")}}positionSelectionHandle(){if(!this.selectedCell||!this.selectionHandle)return;let t=this.selectedCell.getBoundingClientRect(),e=this.container.getBoundingClientRect();this.selectionHandle.style.left=`${t.right-e.left-3}px`,this.selectionHandle.style.top=`${t.bottom-e.top-3}px`}setData(t=null,e=null){t=t||new r,e&&e.forEach(e=>{t.set(e.row,e.col,e)}),this.parser=new g(t),this.data=t,this.updateGridDimensions(),this.renderHeaders(),this.renderRowNumbers(),this.updateVisibleGrid(!0)}renderHeaders(){this.headerContainer.innerHTML=`<div class="header-cell" style="width:${this.rowNumberWidth}px;"></div>`,this.headerContainer.onmousedown=t=>{0===t.button&&null!=t.target.getAttribute("data-col")&&(this.draggingHeader={origLeft:t.target.style.left,el:t.target,col:parseInt(t.target.getAttribute("data-col"))})};let t=this.rowNumberWidth;for(let e=0;e<=this.totalColBounds;e++){let i=this.getColWidth(e);t+=i;let s=document.createElement("div");s.className="header-cell",s.setAttribute("data-hccol",e),s.textContent=this.getColumnName(e),s.style.width=`${i}px`;let l=document.createElement("div");l.className="header-handle",l.style.height=`${this.headerRowHeight}px`,l.setAttribute("data-col",e),l.style.left=`${t-8}px`,this.headerContainer.appendChild(s),this.headerContainer.appendChild(l)}this.headerContainer.style.width=`${t+10}px`}createRowNumber(t){let e=document.createElement("div");return e.className="row-number",e.innerHTML=`<div>${t}</div>`,e}renderRowNumbers(){this.rowNumberContainer.innerHTML="",this.rowNumberContainer.onmousedown=t=>{0===t.button&&null!=t.target.getAttribute("data-row")&&(this.draggingRow={origTop:t.target.style.top,el:t.target,row:parseInt(t.target.getAttribute("data-row"))})};let t=0;for(let e=0;e<=this.totalRowBounds;e++){let i=this.createRowNumber(e+1);t+=this.rowHeight(e),i.style.height=`${this.rowHeight(e)}px`,i.style.lineHeight=`${this.rowHeight(e)}px`,i.setAttribute("data-rnrow",e),this.rowNumberContainer.appendChild(i);let s=document.createElement("div");s.className="row-handle",s.setAttribute("data-row",e),s.style.top=`${t-5}px`,this.rowNumberContainer.appendChild(s)}this.rowNumberContainer.style.height=`${t+20}px`}get totalRowBounds(){return this.heightAccum?.length||this.blockRows}get totalColBounds(){return this.widthAccum?.length||this.blockCols}get totalYBounds(){return this.heightAccum[this.heightAccum.length-1]}get totalXBounds(){return this.widthAccum[this.widthAccum.length-1]}updateHeightAccum(){let t=this.totalRowBounds,e=this.heightAccum.length;this.heightAccum=[this.headerRowHeight];let i=this.headerRowHeight,s=this.container.clientHeight+this.container.scrollTop>=this.container.scrollHeight-150;for(let l=0;l<e-1||l%this.blockRows!=0||l<this.totalRows||s&&l<t+this.blockRows;l++)this.heightAccum.push(i+=this.heightOverrides[l]??this.cellHeight)}updateWidthAccum(){let t=this.totalColBounds,e=this.widthAccum.length;this.widthAccum=[this.rowNumberWidth];let i=this.rowNumberWidth,s=this.container.clientWidth+this.container.scrollLeft>=this.container.scrollWidth-150;for(let l=0;l<e-1||l%this.blockCols!=0||l<this.totalCols||s&&l<t+this.blockCols;l++)this.widthAccum.push(i+=this.getColWidth(l))}updateGridDimensions(){this.updateHeightAccum(),this.updateWidthAccum()}handleScroll(){let t=this.container.clientHeight+this.container.scrollTop>=this.container.scrollHeight-150,e=this.container.clientWidth+this.container.scrollLeft>=this.container.scrollWidth-150;t||e?(console.log("SCROLL UPDATE VIS HEIGHT OR WIDTH"),this.updateGridDimensions(),this.renderRowNumbers(),this.renderHeaders(),this.forceRerender()):this.updateVisibleGrid(),this.updateSelection()}calculateVisibleRange(){let{row:t,col:e}=this.getTopLeftBounds(),{row:i,col:s}=this.getBottomRightBounds();this.visibleStartRow=t,this.visibleStartCol=e,this.visibleEndRow=i,this.visibleEndCol=s}updateVisibleGrid(t=!1){let e=this.padding,i=Math.floor(this.totalRowBounds/this.blockRows),s=Math.floor(this.totalColBounds/this.blockCols);this.calculateVisibleRange();let l=new Set,o=Math.max(0,Math.floor(this.visibleStartRow/this.blockRows)-e),n=Math.min(i,Math.floor((this.visibleEndRow-1)/this.blockRows)),r=Math.max(0,Math.floor(this.visibleStartCol/this.blockCols)-e),a=Math.min(s,Math.floor((this.visibleEndCol-1)/this.blockCols));for(let t=o;t<=n;t++)for(let e=r;e<=a;e++)l.add(`${t},${e}`);let h=[];this.activeBlocks.forEach((e,i)=>{(t||!l.has(i))&&(h.push(i),this.releaseBlock(e))}),h.forEach(t=>this.activeBlocks.delete(t)),requestAnimationFrame(()=>{l.forEach(t=>{if(this.activeBlocks.has(t)){let e=this.activeBlocks.get(t);this.positionBlock(e)}else{let[e,i]=t.split(",").map(Number);this.createBlock(e,i)}})})}blockCanvases(){return devicePixelRatio>=1.875?4:devicePixelRatio>1.7?2:1}positionBlock(t){let e=this.rowNumberWidth;for(let i=0;i<t.startCol;i++)e+=this.getColWidth(i);let i=this.heightAccum[t.startRow];t.blockContainer.style.left=`${e}px`,t.blockContainer.style.top=`${i}px`,t.blockContainer.style.display="block"}positionSubBlock(t,e){0!==e&&((1===e||3===e)&&(t.canvas.style.left=`${t.parentBlock.subBlocks[0].styleWidth}px`),e>=2&&(t.canvas.style.top=`${t.parentBlock.subBlocks[0].styleHeight}px`))}createBlock(t,e){let i=t*this.blockRows,s=Math.min(i+this.blockRows),l=e*this.blockCols,o=Math.min(l+this.blockCols),n=document.createElement("div");n.id=`${t},${e}`,n.className="canvas-block-container";let r=(i=null)=>{let s=document.createElement("canvas");return s.className="canvas-block",s.id=`canvas-${t},${e}${null!=i?"__"+i:""}`,s},a={startRow:i,endRow:s,startCol:l,endCol:o,blockRow:t,blockCol:e,blockContainer:n,canvas:null,subBlocks:[]},h=`${t},${e}`;if(this.activeBlocks.set(h,a),this.calculateBlockDimensionsContainer(a),this.positionBlock(a),n.parentNode||this.container.appendChild(n),1===this.blockCanvases())a.canvas=r(),n.appendChild(a.canvas),this.calculateBlockDimensions(a),this.renderBlock(a);else{2===this.blockCanvases()?a.subBlocks.push({startRow:i,startCol:l,endRow:s,endCol:Math.floor((l+o)/2),canvas:r(0),parentBlock:a,isSubBlock:!0,index:0},{startRow:i,startCol:Math.floor((l+o)/2),endRow:s,endCol:o,canvas:r(1),parentBlock:a,isSubBlock:!0,index:1}):a.subBlocks.push({startRow:i,startCol:l,endRow:Math.floor((i+s)/2),endCol:Math.floor((l+o)/2),canvas:r(0),parentBlock:a,isSubBlock:!0,index:0},{startRow:i,startCol:Math.floor((l+o)/2),endRow:Math.floor((i+s)/2),endCol:o,canvas:r(1),parentBlock:a,isSubBlock:!0,index:1},{startRow:Math.floor((i+s)/2),startCol:l,endRow:s,endCol:Math.floor((l+o)/2),canvas:r(2),parentBlock:a,isSubBlock:!0,index:2},{startRow:Math.floor((i+s)/2),startCol:Math.floor((l+o)/2),endRow:s,endCol:o,canvas:r(3),parentBlock:a,isSubBlock:!0,index:3});for(let t=0;t<this.blockCanvases();t++)n.appendChild(a.subBlocks[t].canvas),this.calculateBlockDimensions(a.subBlocks[t]),this.positionSubBlock(a.subBlocks[t],t),this.renderBlock(a.subBlocks[t])}return a}calculateBlockDimensions(t){let e=this.effectiveDevicePixelRatio();t.width=0;let i=0;for(let i=t.startCol;i<t.endCol;i++)t.width+=this.getColWidth(i)*e;t.width=Math.round(t.width),i=t.width/e,t.height=(this.heightAccum[t.endRow]-this.heightAccum[t.startRow])*e,t.height=Math.round(t.height);let s=t.height/e;t.canvas.width=t.width,t.canvas.height=t.height,t.canvas.style.width=`${i}px`,t.canvas.style.height=`${s}px`;let l=t.canvas.getContext("2d",{alpha:!1});t.styleHeight=s,t.styleWidth=i,l.scale(1,1)}calculateBlockDimensionsContainer(t){let e=this.effectiveDevicePixelRatio();t.width=0;for(let i=t.startCol;i<t.endCol;i++)t.width+=this.getColWidth(i)*e;t.width=Math.round(t.width),t.width=t.width/e,t.height=(this.heightAccum[t.endRow]-this.heightAccum[t.startRow])*e,t.height=Math.round(t.height),t.height=t.height/e,t.blockContainer.style.width=`${t.width}px`,t.blockContainer.style.height=`${t.height}px`,t.styleWidth=t.width,t.styleHeight=t.height}effectiveDevicePixelRatio(){return devicePixelRatio}blockKey(t){return`${t.blockRow},${t.blockCol}`}rowHeight(t){return this.heightOverrides[t]??this.cellHeight}leftBlock(t){if(!t.isSubBlock)return this.getBlock(t.blockRow,t.blockCol-1);if(0===t.index){let e=this.getBlock(t.parentBlock.blockRow,t.parentBlock.blockCol-1);if(!e)return;return e.subBlocks?.[1]}if(1===t.index)return t.parentBlock.subBlocks?.[0];if(2===t.index){let e=this.getBlock(t.parentBlock.blockRow,t.parentBlock.blockCol-1);if(!e)return;return e.subBlocks?.[e.subBlocks?.length-1]}if(3===t.index)return t.parentBlock.subBlocks?.[2];return null}blockFromRc(t,e){let i=Math.floor(t/34),s=Math.floor(e/34),l=this.getBlock(i,s);if(!l)return null;if(0===l.subBlocks.length)return l;for(let i of l.subBlocks)if(t>=i.startRow&&t<=i.endRow&&e>=i.startCol&&e<=i.endCol)return i;return null}getKey(t,e){return`${t},${e}`}getWidthHeight(t,e){let i,s,l=this.getMerge(t,e);return l?(i=this.getWidthBetweenColumns(l.startCol,l.endCol+1),s=this.getHeightBetweenRows(l.startRow,l.endRow+1)):(i=this.getCellWidth(t,e),s=this.getHeight(t,e)),{width:i,height:s}}getBlock(t,e){let i=Math.floor(t/this.blockRows),s=Math.floor(e/this.blockCols),l=this.getKey(i,s);return this.activeBlocks.has(l)?this.activeBlocks.get(l):null}getBlockOrSubBlock(t,e){let i=this.getBlock(t,e);if(!i)return null;if(0===i.subBlocks.length)return i;if(2===i.subBlocks.length){let t=e%this.blockCols,s=Math.floor(this.blockCols/2);return i.subBlocks[+(t>=s)]}if(4===i.subBlocks.length){let s=e%this.blockCols>=Math.floor(this.blockCols/2),l=t%this.blockRows>=Math.floor(this.blockRows/2),o=0;return s||l?s&&!l?o=1:!s&&l?o=2:s&&l&&(o=3):o=0,i.subBlocks[o]}return null}getCellCoordsContainer(t,e){let i,s,l,o,n=this.getMerge(t,e);return n?(i=this.getWidthOffset(n.startCol,!0),s=this.getHeightOffset(n.startRow,!0),l=this.getMergeWidth(n),o=this.getMergeHeight(n),t=n.startRow,e=n.startCol):(i=this.getWidthOffset(e,!0),s=this.getHeightOffset(t,!0),l=this.getCellWidth(t,e),o=this.rowHeight(t)),{left:i,top:s,width:l,height:o,row:t,col:e}}getCellCoordsCanvas(t,e){let i,s,l,o,n=this.getBlockOrSubBlock(t,e),r=this.getMerge(t,e);return r?(i=this.getWidthBetweenColumns(n.startCol,r.startCol),s=this.getHeightBetweenRows(n.startRow,r.startRow),l=this.getMergeWidth(r),o=this.getMergeHeight(r),t=r.startRow,e=r.startCol):(i=this.getWidthBetweenColumns(n.startCol,e),s=this.getHeightBetweenRows(n.startRow,t),l=this.getCellWidth(t,e),o=this.rowHeight(t)),{left:i,top:s,width:l,height:o,row:t,col:e}}renderBorders(t,e,i){if(!this.getCell(e,i)?.border)return;let s=this.getCell(e,i)?.border;t.save(),t.strokeStyle="red",w(s,"left")&&(t.beginPath(),t.moveTo(this.getWidthOffset(i)*devicePixelRatio,this.getHeightOffset(e)*devicePixelRatio),t.lineTo(this.getWidthOffset(i)*devicePixelRatio,(this.getHeightOffset(e)+this.getCellHeight(e))*devicePixelRatio),t.stroke()),w(s,"top")&&(t.beginPath(),t.moveTo(this.getWidthOffset(i)*devicePixelRatio,this.getHeightOffset(e)*devicePixelRatio),t.lineTo((this.getWidthOffset(i)+this.getCellWidth(i))*devicePixelRatio,this.getHeightOffset(e)*devicePixelRatio),t.stroke()),w(s,"right")&&(t.beginPath(),t.moveTo((this.getWidthOffset(i)+this.getCellWidth(i))*devicePixelRatio,this.getHeightOffset(e)*devicePixelRatio),t.lineTo((this.getWidthOffset(i)+this.getCellWidth(i))*devicePixelRatio,(this.getHeightOffset(e)+this.getCellHeight(e))*devicePixelRatio),t.stroke()),w(s,"bottom")&&(t.beginPath(),t.moveTo(this.getWidthOffset(i)*devicePixelRatio,(this.getHeightOffset(e)+this.getCellHeight(e))*devicePixelRatio),t.lineTo((this.getWidthOffset(i)+this.getCellWidth(i))*devicePixelRatio,(this.getHeightOffset(e)+this.getCellHeight(e))*devicePixelRatio),t.stroke()),t.restore()}renderCell(t,e,i,s){if(!s){let l=i;l||(l=this.getBlockOrSubBlock(t,e)),l&&(s=l.canvas.getContext("2d",{alpha:!1}))}let{left:l,top:o,width:n,height:r}=this.getCellCoordsCanvas(t,e);if(s&&(s.fillStyle="#ffffff"),!i||this.rowColInBounds(t,e,i))s&&s.fillRect((l+1)*devicePixelRatio,(o+1)*devicePixelRatio,(n-2)*devicePixelRatio,(r-2)*devicePixelRatio);else{i.startRow,i.endCol;let a=this.getMerge(t,e);if(!a)return;t=a.startRow,e=a.startCol;let h=this.getWidthBetweenColumns(i.startCol,a.endCol+1),d=this.getHeightBetweenRows(i.startRow,a.endRow+1);l=h-n,o=d-r,s&&s.fillRect((l+1)*devicePixelRatio,(o+1)*devicePixelRatio,(n-2)*devicePixelRatio,(r-2)*devicePixelRatio)}if(s&&(s.fillStyle="#333333"),this.renderBorders(s,t,e),"button"===this.getCell(t,e).cellType){let i=this.getButton(t,e).el;({left:l,top:o,width:n,height:r}=this.getCellCoordsContainer(t,e)),this.positionElement(i,l,o,n,r)}else if("linechart"===this.getCell(t,e).cellType){let i=this.getLineChart(t,e)?.el;({left:l,top:o,width:n,height:r}=this.getCellCoordsContainer(t,e)),this.positionElement(i,l,o,n,r)}else if(this.clearElRegistry(t,e),this.renderCellText(s,l,o,n,t,e),h[t]?.[e])for(let i in h[t][e])for(let s in h[t][e][i])this.renderCell(i,s)}scalerZoom(){return devicePixelRatio}renderBlock(t,e=!1){let i;e&&this.calculateBlockDimensions(t);let s=t.canvas.getContext("2d",{alpha:!1});s.fillStyle="#ffffff",s.fillRect(0,0,t.canvas.width,t.canvas.height),this.applyRenderingQuality(s);let l=0;if(s.textAlign="left",s.textBaseline="middle",s.fillStyle="#333333",s.strokeStyle="hsl(0,0%,88%)",s.lineWidth=1,s.font=this.getFontString(),s.translate(.5,.5),this.gridlinesOn&&"performance"!==this.quality())for(let e=t.startRow;e<t.endRow;e++)i=Math.round((this.heightAccum[e]-this.heightAccum[t.startRow])*devicePixelRatio),s.beginPath(),s.moveTo(0,i),s.lineTo(t.canvas.width,i),s.stroke();if(this.gridlinesOn&&"performance"!==this.quality())for(let e=t.startCol;e<t.endCol;e++){let i=this.getColWidth(e);s.beginPath(),s.moveTo(Math.round(l*devicePixelRatio),0),s.lineTo(Math.round(l*devicePixelRatio),t.canvas.height),s.stroke(),l+=i}l=0;for(let e=t.startCol;e<t.endCol;e++){let i=this.getColWidth(e);for(let o=t.startRow;o<t.endRow;o++){if(!this.getCell(o,e))continue;let n=this.getMerge(o,e);if(n)continue;let r=this.heightAccum[o]-this.heightAccum[t.startRow];if("button"===this.getCell(o,e).cellType){if(!n){let t=this.getButton(o,e).el;this.positionElement(t,this.widthAccum[e],this.heightAccum[o],i,this.rowHeight(o))}}else if("linechart"===this.getCell(o,e).cellType){let t=this.getLineChart(o,e)?.el;this.positionElement(t,this.widthAccum[e],this.heightAccum[o],i,this.rowHeight(o))}else this.renderBorders(s,o,e),this.renderCellText(s,l,r,i,o,e)}l+=i}this.renderMergesOnBlock(t,s)}renderMergesOnBlock(t,e){for(let i of this.getMergesInRange(t)){let s=i.startRow,l=i.startCol;this.renderCell(s,l,t,e)}}clearElRegistry(t,e){let i=this.getCellId(t,e);this.elRegistry[i]&&this.elRegistry[i].el.parentNode?.removeChild(this.elRegistry[i].el)}isSelectStart(t,e){if(this.selectionStart)return this.selectionStart.row===t&&this.selectionStart.col===e}isSelectEnd(t,e){if(this.selectionEnd)return this.selectionEnd.row===t&&this.selectionEnd.col===e}positionElement(t,e,i,s,l,o=!0){t.style.top=`${i}px`,t.style.left=`${e}px`,t.style.width=`${s}px`,t.style.height=`${l}px`,o&&this.container.appendChild(t)}getCellId(t,e){return this.getCell(t,e)?._id}getButton(t,e){let i=this.getCellId(t,e);if(this.elRegistry[i]&&"button"===this.elRegistry[i].type)return this.elRegistry[i];this.elRegistry[i]&&"button"!==this.elRegistry.type&&this.elRegistry[i].el.parentNode?.removeChild(this.elRegistry[i].el);let s=document.createElement("button");return s.textContent=this.getCellText(t,e),s.onclick=t=>t.stopPropagation(),s.ondblclick=t=>t.stopPropagation(),s.style.zIndex=1,s.style.position="absolute",s.style.overflow="hidden",s.style.userSelect="none",this.elRegistry[i]={type:"button",el:s},this.elRegistry[i]}getLineChart(t,e){let i=this.getCellId(t,e);if(this.elRegistry[i]&&"lineChart"===this.elRegistry[i].type){let s=this.elRegistry[i].data,{width:l,height:o}=this.getWidthHeight(t,e);return this.elRegistry[i].lineChart.render(s,l,o),this.elRegistry[i]}this.elRegistry[i]&&"lineChart"!==this.elRegistry[i].type&&this.elRegistry[i].el.parentNode?.removeChild(this.elRegistry[i].el);let s=[["10","2023-01-01"],["15","2023-01-02"],["12","2023-01-03"],["20","2023-01-04"],["18","2023-01-05"],["25","2023-01-06"],["22","2023-01-07"]],l=document.createElement("div");l.onclick=t=>t.stopPropagation(),l.ondblclick=t=>t.stopPropagation(),l.style.zIndex=1,l.style.position="absolute",l.style.overflow="hidden",l.style.height="100%",l.style.width="100%";let{width:o,height:n}=this.getWidthHeight(t,e),r=function(t,e,i,s){function l(t,i,s){e.innerHTML="",e.innerHTML=`
                    <div class="chart-container">
                        <div class="chart"></div>
                    </div>
                    <div class="tooltip"></div>
                `;let l=e.querySelector(".chart"),o=e.querySelector(".tooltip"),n=t.map(t=>({value:parseFloat(t[0]),date:t[1]})),r=i-50-50,a=s-20-50,h=document.createElementNS("http://www.w3.org/2000/svg","svg");h.setAttribute("width",i),h.setAttribute("height",s),h.style.overflow="visible",l.appendChild(h);let d=document.createElementNS("http://www.w3.org/2000/svg","g");d.setAttribute("transform","translate(50, 20)"),h.appendChild(d);let c=(t,e)=>{let i=n.length,s=.02*r;return s+e/(i-1)*(r-2*s)},u=Math.max(...n.map(t=>t.value)),g=t=>a-t/u*a,p=document.createElementNS("http://www.w3.org/2000/svg","path"),f="M";n.forEach((t,e)=>{let i=c(t.date,e),s=g(t.value);f+=`${i},${s} `,e<n.length-1&&(f+="L");let l=document.createElementNS("http://www.w3.org/2000/svg","circle");l.setAttribute("class","point"),l.setAttribute("cx",i),l.setAttribute("cy",s),l.setAttribute("r",4),l.setAttribute("data-value",t.value),l.setAttribute("data-date",t.date),l.addEventListener("mouseover",e=>{o.style.display="block",o.innerHTML=`Date: ${t.date}<br>Value: ${t.value}`,o.style.left=e.pageX+10+"px",o.style.top=e.pageY-10+"px"}),l.addEventListener("mouseout",()=>{o.style.display="none"}),d.appendChild(l)}),p.setAttribute("class","line"),p.setAttribute("d",f),d.appendChild(p),n.forEach((t,e)=>{if(e%Math.ceil(n.length/5)==0||e===n.length-1){let i=c(t.date,e);if(i>=0&&i<=r){let e=document.createElementNS("http://www.w3.org/2000/svg","text");e.setAttribute("class","x-axis"),e.setAttribute("x",i),e.setAttribute("y",a+20),e.setAttribute("text-anchor","middle");let s=t.date.length>10?t.date.substring(5):t.date;e.textContent=s;let l=6*s.length;i+l/2>r?(e.setAttribute("text-anchor","end"),e.setAttribute("x",r-5)):i-l/2<0&&(e.setAttribute("text-anchor","start"),e.setAttribute("x",5)),d.appendChild(e)}}});for(let t=0;t<=5;t++){let e=u/5*t,i=document.createElementNS("http://www.w3.org/2000/svg","text");i.setAttribute("class","y-axis"),i.setAttribute("x",-10),i.setAttribute("y",g(e)),i.setAttribute("text-anchor","end"),i.setAttribute("dy","0.35em"),i.textContent=e.toFixed(1),d.appendChild(i);let s=document.createElementNS("http://www.w3.org/2000/svg","line");s.setAttribute("x1",0),s.setAttribute("y1",g(e)),s.setAttribute("x2",r),s.setAttribute("y2",g(e)),s.setAttribute("stroke","#eee"),s.setAttribute("stroke-dasharray","2,2"),d.insertBefore(s,d.firstChild)}let w=document.createElementNS("http://www.w3.org/2000/svg","text");w.setAttribute("class","x-axis"),w.setAttribute("x",r/2),w.setAttribute("y",a+40),w.setAttribute("text-anchor","middle"),w.textContent="Date",d.appendChild(w);let C=document.createElementNS("http://www.w3.org/2000/svg","text");C.setAttribute("class","y-axis"),C.setAttribute("transform","rotate(-90)"),C.setAttribute("x",-a/2),C.setAttribute("y",-40),C.setAttribute("text-anchor","middle"),C.textContent="Value",d.appendChild(C)}return console.log("createlinecahrt?"),l(t,i,s),{container:e,update:function(){e.innerHTML=""},destroy:function(){e.innerHTML=""},render:l}}(s,l,o,n);return this.elRegistry[i]={el:l,lineChart:r,data:s,type:"lineChart"},this.elRegistry[i]}getWidthOffset(t,e=!1){return this.widthAccum[t]-(e?0:this.rowNumberWidth)}getHeightOffset(t,e=!1){return this.heightAccum[t]-(e?0:this.headerRowHeight)}getCellWidth(t,e=null){let i=t;return"number"==typeof e&&(i=e),this.getColWidth(i)}getCellHeight(t,e=null){return this.rowHeight(t)}getHeight(t,e=null){return this.rowHeight(t)}getWidthBetweenColumns(t,e){let i=0;for(let s=t;s<e;s++)i+=this.getColWidth(s);return i}getHeightBetweenRows(t,e){if(e<t){let i=e;e=t,t=i}return this.heightAccum[e]-this.heightAccum[t]}quality(){let t=window.devicePixelRatio;return t<.5?"performance":t<1?"balance":"max"}applyRenderingQuality(t){"performance"===this.quality()?(t.textRendering="optimizeSpeed",t.imageSmoothingEnabled=!1):(t.textRendering="geometricPrecision",t.imageSmoothingEnabled=!0)}getCell(t,e){return this.data?this.data.get(t,e):{row:t,col:e}}getCellText(t,e){return this.getCell(t,e)?.text||""}getCellTextAlign(t,e){return this.getCell(t,e)?.textAlign}renderCellText(t,e,i,s,l,o,n=""){let r=this.getCellText(l,o),a=null!=r?String(r):"";""!==n&&(a=n);try{var c,g;for(let[t,e]of function(t,e){let i=[],s=d[t]?.[e];if(!s)return[];for(let t in s)for(let e in s[t])i.push([t,e]);return i}(l,o)){let i=h[t]?.[e];i&&i[l]?.[o]&&(delete i[l][o],u(i[l])&&delete i[l])}c=l,g=o,d[c]?.[g]&&(delete d[c][g],u(d[c])&&delete d[c]),a=this.parser.evaluateExpression(a,[l,o])}catch(t){console.warn(t)}""!==a&&(t.save(),this.getCellColor(l,o)&&(t.fillStyle=this.getCellColor(l,o)),this.getCell(l,o)?.fontSize!=null&&(t.font=this.getFontString(l,o)),this.getCell(l,o)?.textBaseline!=null&&(t.textBaseline=this.getCell(l,o).textBaseline),t.beginPath(),this.getCellTextAlign(l,o)&&(t.textAlign=this.getCellTextAlign(l,o)),t.rect(e*devicePixelRatio,i*devicePixelRatio,s*devicePixelRatio,this.rowHeight(l)*devicePixelRatio),t.clip(),t.fillText(a,(e+4)*devicePixelRatio,(i+this.rowHeight(l)/2)*devicePixelRatio),t.restore())}getCellColor(t,e){return this.getCell(t,e)?.color??""}getAbbreviatedText(t){return t.length>8?t.substring(0,5)+"...":t}getFontString(t=null,e=null){let i=12*devicePixelRatio;null!=t&&null!=e&&null!=this.getCell(t,e).fontSize&&(i=this.getCell(t,e).fontSize);let s=`${i}px Arial`;return"max"===this.quality()&&devicePixelRatio>=1&&(s+=", sans-serif"),s}releaseBlock(t){if(t.subBlocks.length>1)for(;t.subBlocks.length>1;)t.subBlocks.pop();t.blockContainer.innerHTML="",t.blockContainer.parentNode.removeChild(t.blockContainer)}}class x{constructor(t,e){this.curId=1,this.curActiveGridId=1,this.activeGrids=new Map,this.wrapper=document.getElementById(t)||document.createElement("div");let i=document.createElement("div");this._container=i,i.style.width="100%",i.style.height="100%",i.style.display="flex",i.style.flexDirection="column",i.innerHTML=`
            <div id="sheets-container" class="sheets-container" style="display:flex;flex:1;flex-direction:column;height:calc(100% - 40px);">
            </div>
        `,this.bottomBar=new o,i.appendChild(this.bottomBar.container),this.wrapper.appendChild(i),this.addSheetButton=i.querySelector(".gigasheet-icon-img.add"),this.sheetsContainer=i.querySelector(".sheets-container"),this.initEventListeners(),this.initSheets(e)}initEventListeners(){this.addSheetButton.onclick=t=>{t.preventDefault(),this.addGrid()},this.bottomBar.onTabClicked(t=>{this.switchTab(t)})}switchTab(t){let e=this.activeGrids.get(t);if(e){for(let t of this.sheetsContainer.children)t.style.display="none";e._container.style.display="flex"}}getDefaultOptions(){return{gridlinesOn:!0}}addGrid(t){for(let t of this.sheetsContainer.children)t.style.display="none";this.activeGrids.set(String(this.curId++),new y(this.sheetsContainer,t||this.getDefaultOptions())),this.bottomBar.addTab("Sheet",this.curId-1)}initSheets(t){if(null!=t&&t.length>0)for(let e=0;e<t.length;e++)this.addGrid(t);else this.addGrid()}}document.addEventListener("DOMContentLoaded",t=>{new x("grid-wrapper")});
//# sourceMappingURL=gigaspreadsheet.a5d21c63.js.map
